<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการสินค้า QR Code - Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <!-- SheetJS for Excel support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ⚡ Firestore imports
        import { getFirestore, doc, collection, addDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ⚡ Firebase Authentication imports
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // ✅ Firebase Project: qr-code-41c9f
        const firebaseConfig = {
            apiKey: "AIzaSyAhdicjO5J8AJxBnKaGul9tYwqtXHIKZfo",
            authDomain: "qr-code-41c9f.firebaseapp.com",
            projectId: "qr-code-41c9f",
            storageBucket: "qr-code-41c9f.firebasestorage.app",
            messagingSenderId: "403381830838",
            appId: "1:403381830838:web:3fe287f2984ad6777f5217",
            measurementId: "G-6BKSB7WE7Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Make Firebase available globally
        window.db = db;
        window.auth = auth;
        window.firebaseModules = {
            collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        /* QR Sticker Styles - Real world sizing */
        .qr-sticker {
            width: 4in;
            height: 2in;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            font-family: 'Kanit', sans-serif;
            page-break-inside: avoid;
            margin: 5px;
        }
        
        .qr-sticker-compact {
            width: 3in;
            height: 1.5in;
            border: 1px solid #ccc;
            padding: 8px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            font-family: 'Kanit', sans-serif;
            page-break-inside: avoid;
            margin: 5px;
        }
        
        .qr-sticker-minimal {
            width: 2in;
            height: 1in;
            border: 1px solid #ccc;
            padding: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            font-family: 'Kanit', sans-serif;
            page-break-inside: avoid;
            margin: 5px;
        }
        
        /* Selected sticker styling */
        .selected { 
            outline: 2px dashed red; 
        }
        
        /* Legacy sticker class for backward compatibility */
        .sticker { 
            width: 384px; /* 4 inches at 96 DPI */
            height: 192px; /* 2 inches at 96 DPI */
            border: 2px solid #333; 
            padding: 8px; 
            margin: 10px; 
            page-break-inside: avoid;
        }
        .autocomplete-container { position: relative; }
        .autocomplete-list { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #ccc; 
            border-top: none; 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-item { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover { background-color: #f0f0f0; }
        .autocomplete-item.selected { background-color: #e3f2fd; }
        .realtime-indicator { 
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #00ff00;
            border-radius: 8px;
            z-index: 10;
        }
        @page {
            size: A4;
            margin: 5mm;
        }
        
        @media print {
            body { 
                font-family: 'Kanit', sans-serif; 
                display: flex; 
                flex-wrap: wrap; 
            }
            
            .qr-sticker {
                width: 4in;
                height: 2in;
                border: 1px solid #ccc;
                padding: 10px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 5px;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .qr-sticker-compact {
                width: 3in;
                height: 1.5in;
                border: 1px solid #ccc;
                padding: 8px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 5px;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .qr-sticker-minimal {
                width: 2in;
                height: 1in;
                border: 1px solid #ccc;
                padding: 5px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                margin: 5px;
                page-break-inside: avoid;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .selected { 
                outline: 2px dashed red; 
            }
            
            /* Hide non-print elements */
            .no-print, 
            .page-checkbox,
            button,
            .bg-blue-600,
            .bg-purple-600,
            .bg-green-600,
            #pageControls {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">


    <!-- Login/Register Section -->
    <div id="loginSection" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-boxes text-5xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ระบบจัดการสินค้า QR Code</h1>
                <p class="text-gray-600">Advanced Inventory Management System v3.0</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form onsubmit="login(event)" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">อีเมล</label>
                        <div class="relative">
                            <input type="email" id="loginEmail" required 
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="กรอกอีเมล">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                        <div class="relative">
                            <input type="password" id="loginPassword" required 
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                                   placeholder="กรอกรหัสผ่าน">
                            <i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold transition-colors transform hover:scale-105">
                        <i class="fas fa-sign-in-alt mr-2"></i>เข้าสู่ระบบ
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-600">ยังไม่มีบัญชี? 
                        <button onclick="showRegisterForm()" class="text-blue-600 hover:text-blue-800 font-semibold">
                            ลงทะเบียนที่นี่
                        </button>
                    </p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <form onsubmit="register(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">อีเมล</label>
                        <div class="relative">
                            <input type="email" id="registerEmail" required 
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                   placeholder="กรอกอีเมล">
                            <i class="fas fa-envelope absolute left-4 top-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                        <div class="relative">
                            <input type="password" id="registerPassword" required minlength="6"
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                   placeholder="รหัสผ่านอย่างน้อย 6 ตัวอักษร">
                            <i class="fas fa-lock absolute left-4 top-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                        <div class="relative">
                            <input type="text" id="registerFullName" required 
                                   class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all"
                                   placeholder="กรอกชื่อ-นามสกุล">
                            <i class="fas fa-user absolute left-4 top-4 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div id="roleSelection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ตำแหน่ง</label>
                        <select id="registerRole" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            <option value="admin">ผู้ดูแลระบบ</option>
                            <option value="warehouse">พนักงานคลัง</option>
                            <option value="purchase">ฝ่ายจัดซื้อ</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors transform hover:scale-105">
                        <i class="fas fa-user-plus mr-2"></i>ลงทะเบียน
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <p class="text-gray-600">มีบัญชีแล้ว? 
                        <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-800 font-semibold">
                            เข้าสู่ระบบที่นี่
                        </button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header id="mainHeader" class="gradient-bg text-white shadow-lg hidden">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-boxes text-3xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">ระบบจัดการสินค้า QR Code</h1>
                        <div class="flex items-center space-x-2 text-sm">
                            <span id="connectionStatus" class="realtime-indicator bg-green-400 w-2 h-2 rounded-full"></span>
                            <span id="connectionText">Real-time Dashboard</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm" id="currentUserDisplay">ผู้ใช้: -</div>
                        <div class="text-xs opacity-75" id="currentRoleDisplay">สิทธิ์: -</div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>ออกจากระบบ
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="mainNavigation" class="bg-white shadow-md hidden">
        <div class="container mx-auto px-6">
            <div class="flex space-x-8" id="navigationMenu">
                <!-- Navigation will be populated based on user role -->
            </div>
        </div>
    </nav>

    <!-- Quick Search Bar -->
    <div id="quickSearchBar" class="bg-blue-50 border-b hidden">
        <div class="container mx-auto px-6 py-3">
            <div class="flex items-center space-x-4">
                <div class="flex-1 autocomplete-container">
                    <div class="relative">
                        <input type="text" id="quickSearch" placeholder="ค้นหาเร็ว: รหัสสินค้า, Job No., ชื่อสินค้า, ลูกค้า..." 
                               class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               onkeyup="quickSearch()" onfocus="showQuickSearchResults()">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <div id="quickSearchResults" class="autocomplete-list hidden"></div>
                </div>
                <button onclick="startBarcodeScanner()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-camera mr-2"></i>สแกน
                </button>
            </div>
        </div>
    </div>

    <!-- Real-time Dashboard -->
    <div id="dashboardSection" class="container mx-auto px-6 py-4 hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-100 text-sm">สินค้าทั้งหมด</p>
                        <p class="text-2xl font-bold" id="dashTotalItems">0</p>
                        <p class="text-xs text-blue-200">อัพเดทล่าสุด: <span id="dashLastUpdate">-</span></p>
                    </div>
                    <i class="fas fa-boxes text-3xl text-blue-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-100 text-sm">รับเข้าวันนี้</p>
                        <p class="text-2xl font-bold" id="dashTodayReceive">0</p>
                        <p class="text-xs text-green-200">เมื่อเทียบกับเมื่อวาน: <span id="dashReceiveTrend">-</span></p>
                    </div>
                    <i class="fas fa-arrow-down text-3xl text-green-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-100 text-sm">จ่ายออกวันนี้</p>
                        <p class="text-2xl font-bold" id="dashTodayIssue">0</p>
                        <p class="text-xs text-red-200">เมื่อเทียบกับเมื่อวาน: <span id="dashIssueTrend">-</span></p>
                    </div>
                    <i class="fas fa-arrow-up text-3xl text-red-200"></i>
                </div>
            </div>
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg hover-scale">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-100 text-sm">สินค้าใกล้หมด</p>
                        <p class="text-2xl font-bold" id="dashLowStock">0</p>
                        <p class="text-xs text-orange-200">ต่ำกว่า 10 ชิ้น</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-3xl text-orange-200"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="container mx-auto px-6 py-8 hidden">
        <!-- User Management Section -->
        <div id="userManagement" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-users text-purple-600 mr-3"></i>จัดการผู้ใช้งาน
                    </h2>
                    <button onclick="showAddUserForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>เพิ่มผู้ใช้ใหม่
                    </button>
                </div>

                <!-- Add User Form -->
                <div id="addUserForm" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4">เพิ่มผู้ใช้ใหม่</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อผู้ใช้</label>
                            <input type="text" id="newUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                            <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                            <input type="text" id="newFullName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">สิทธิ์การใช้งาน</label>
                            <select id="newUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="warehouse">พนักงานคลัง</option>
                                <option value="purchase">ฝ่ายจัดซื้อ</option>
                                <option value="admin">ผู้ดูแลระบบ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">อีเมล</label>
                            <input type="email" id="newEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">เบอร์โทร</label>
                            <input type="tel" id="newPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="hideAddUserForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">ยกเลิก</button>
                        <button onclick="saveUser()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors">บันทึก</button>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อผู้ใช้</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อ-นามสกุล</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">สิทธิ์</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">สถานะ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">เข้าใช้ล่าสุด</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody" class="divide-y divide-gray-200">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Item Master Section -->
        <div id="itemMaster" class="section">
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-database text-blue-600 mr-3"></i>จัดการข้อมูลสินค้า
                    </h2>
                    <div class="flex space-x-3">
                        <div class="relative">
                            <button onclick="toggleImportMenu()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-file-import mr-2"></i>Import
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            <div id="importMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-40">
                                <button onclick="importExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)
                                </button>
                                <button onclick="importCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv text-blue-600 mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <div class="relative">
                            <button onclick="toggleExportMenu()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-file-export mr-2"></i>Export
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            <div id="exportMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-40">
                                <button onclick="exportExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)
                                </button>
                                <button onclick="exportCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv text-blue-600 mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <button onclick="showAddItemForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>เพิ่มสินค้าใหม่
                        </button>
                    </div>
                </div>

                <!-- Add Item Form -->
                <div id="addItemForm" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4">เพิ่มสินค้าใหม่</h3>
                    
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchTab('basic')" id="basicTab" class="tab-button active py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                                <i class="fas fa-info-circle mr-2"></i>ข้อมูลพื้นฐาน
                            </button>
                            <button onclick="switchTab('product')" id="productTab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-box mr-2"></i>รายละเอียดสินค้า
                            </button>
                            <button onclick="switchTab('customer')" id="customerTab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-user mr-2"></i>ข้อมูลลูกค้า
                            </button>
                            <button onclick="switchTab('production')" id="productionTab" class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                <i class="fas fa-cogs mr-2"></i>ข้อมูลการผลิต
                            </button>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div id="basicTabContent" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่ <span class="text-red-500">*</span></label>
                                <input type="date" id="itemDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">MC (Machine) <span class="text-red-500">*</span></label>
                                <input type="text" id="itemMC" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น MC001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Job No. <span class="text-red-500">*</span></label>
                                <input type="text" id="itemJobNo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น A6808-272">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">กำหนดส่งสินค้า</label>
                                <input type="date" id="itemDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">OE</label>
                                <input type="text" id="itemOE" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น OE001">
                            </div>
                        </div>
                    </div>

                    <div id="productTabContent" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสสินค้า <span class="text-red-500">*</span></label>
                                <input type="text" id="itemProductCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น PRD001">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า <span class="text-red-500">*</span></label>
                                <input type="text" id="itemProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ชื่อสินค้า">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ขนาด</label>
                                <input type="text" id="itemSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น 10x15 cm">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">สี</label>
                                <input type="text" id="itemColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น แดง, น้ำเงิน">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">โลโก้</label>
                                <input type="text" id="itemLogo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ชื่อโลโก้">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วัสดุประกอบ</label>
                                <input type="text" id="itemMaterial" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น พลาสติก, กระดาษ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสฝาประกอบ</label>
                                <input type="text" id="itemCapCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น CAP001">
                            </div>
                        </div>
                    </div>

                    <div id="customerTabContent" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสลูกค้า</label>
                                <input type="text" id="itemCustomerCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="เช่น CUST001">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อลูกค้า <span class="text-red-500">*</span></label>
                                <input type="text" id="itemCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ชื่อบริษัทลูกค้า">
                            </div>
                        </div>
                    </div>

                    <div id="productionTabContent" class="tab-content hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนผลิต</label>
                                <input type="number" id="itemProductionQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">บรรจุ/ถุง</label>
                                <input type="number" id="itemPackPerBag" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" min="0" onchange="calculateBagQty()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนถุง</label>
                                <input type="number" id="itemBagQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">เศษ</label>
                                <input type="number" id="itemWaste" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" min="0">
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">การคำนวณอัตโนมัติ</h4>
                            <p class="text-sm text-blue-700">จำนวนถุง = จำนวนผลิต ÷ บรรจุ/ถุง</p>
                            <div class="mt-2 text-sm">
                                <span class="font-medium">ผลรวม:</span> 
                                <span id="calculatedTotal" class="font-bold text-blue-800">0</span> ชิ้น
                            </div>
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <div class="flex justify-between items-center mt-6">
                        <div class="flex space-x-3">
                            <button id="prevTabBtn" onclick="previousTab()" class="hidden bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-chevron-left mr-2"></i>ก่อนหน้า
                            </button>
                            <button id="nextTabBtn" onclick="nextTab()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ถัดไป<i class="fas fa-chevron-right ml-2"></i>
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="hideAddItemForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">ยกเลิก</button>
                            <button onclick="saveItem()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>บันทึก
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Table Controls -->
                <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">แสดง:</label>
                            <select id="itemsPerPage" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm" onchange="changeItemsPerPage()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-sm text-gray-700">รายการ</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" id="itemTableSearch" placeholder="ค้นหาในตาราง..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm w-64" onkeyup="searchItemTable()">
                            <button onclick="clearItemTableSearch()" class="px-3 py-2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        แสดง <span id="itemsShowingFrom">1</span>-<span id="itemsShowingTo">25</span> จาก <span id="itemsTotal">0</span> รายการ
                    </div>
                </div>

                <!-- Items Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" onclick="sortItemTable('jobNo')">
                                    Job No. <i id="sort-jobNo" class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" onclick="sortItemTable('productCode')">
                                    รหัสสินค้า <i id="sort-productCode" class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" onclick="sortItemTable('productName')">
                                    ชื่อสินค้า <i id="sort-productName" class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" onclick="sortItemTable('customerName')">
                                    ลูกค้า <i id="sort-customerName" class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 cursor-pointer hover:bg-gray-200" onclick="sortItemTable('dueDate')">
                                    กำหนดส่ง <i id="sort-dueDate" class="fas fa-sort ml-1 text-gray-400"></i>
                                </th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody" class="divide-y divide-gray-200">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="mt-4 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <button id="itemsPrevBtn" onclick="previousItemsPage()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-chevron-left mr-1"></i>ก่อนหน้า
                        </button>
                        <div id="itemsPagination" class="flex space-x-1">
                            <!-- Pagination buttons will be generated here -->
                        </div>
                        <button id="itemsNextBtn" onclick="nextItemsPage()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            ถัดไป<i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        หน้า <span id="itemsCurrentPage">1</span> จาก <span id="itemsTotalPages">1</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Sticker Section -->
        <div id="qrSticker" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-qrcode text-green-600 mr-3"></i>สร้างสติกเกอร์ QR Code
                </h2>
                
                <div class="max-w-4xl">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือก Job No.</label>
                        <div class="autocomplete-container">
                            <select id="qrJobSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" onchange="loadJobDetails()">
                                <option value="">-- เลือก Job No. --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="jobDetails" class="hidden bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold mb-3">รายละเอียดงาน</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div><strong>วันที่:</strong> <span id="detailDate"></span></div>
                            <div><strong>MC:</strong> <span id="detailMC"></span></div>
                            <div><strong>OE:</strong> <span id="detailOE"></span></div>
                            <div><strong>รหัสสินค้า:</strong> <span id="detailProductCode"></span></div>
                            <div><strong>ชื่อสินค้า:</strong> <span id="detailProductName"></span></div>
                            <div><strong>ขนาด:</strong> <span id="detailSize"></span></div>
                            <div><strong>สี:</strong> <span id="detailColor"></span></div>
                            <div><strong>ลูกค้า:</strong> <span id="detailCustomerName"></span></div>
                            <div><strong>รหัสฝา:</strong> <span id="detailCapCode"></span></div>
                            <div><strong>บรรจุ/ถุง:</strong> <span id="detailPackPerBag"></span></div>
                            <div class="col-span-2 mt-2 p-2 bg-blue-50 rounded">
                                <strong class="text-blue-800">จำนวนถุงจากข้อมูล:</strong> 
                                <span id="detailBagQty" class="text-blue-900 font-bold text-lg">0</span> ถุง
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนถุงที่จะสร้างสติกเกอร์</label>
                        <div class="flex space-x-2">
                            <input type="number" id="totalBags" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" readonly>
                            <button onclick="useDataBagQty()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>ใช้จากข้อมูล
                            </button>
                            <button onclick="customBagQty()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-edit mr-1"></i>กำหนดเอง
                            </button>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            คลิก "ใช้จากข้อมูล" เพื่อใช้จำนวนถุงจากข้อมูลที่อัปโหลด หรือ "กำหนดเอง" เพื่อใส่จำนวนเอง
                        </div>
                    </div>

                    <!-- Layout Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรูปแบบสติกเกอร์</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-green-500 transition-colors" onclick="selectStickerLayout('standard')" id="layout-standard">
                                <div class="flex items-center space-x-2 mb-2">
                                    <input type="radio" name="stickerLayout" value="standard" checked class="text-green-600">
                                    <span class="font-medium">มาตรฐาน</span>
                                </div>
                                <div class="text-xs text-gray-600">4x2 นิ้ว - ข้อมูลครบถ้วน</div>
                                <div class="mt-2 bg-gray-100 rounded p-2 text-xs">
                                    <div class="flex">
                                        <div class="w-6 h-6 bg-gray-300 rounded mr-2"></div>
                                        <div class="flex-1">
                                            <div class="h-1 bg-gray-400 rounded mb-1"></div>
                                            <div class="h-1 bg-gray-300 rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-green-500 transition-colors" onclick="selectStickerLayout('compact')" id="layout-compact">
                                <div class="flex items-center space-x-2 mb-2">
                                    <input type="radio" name="stickerLayout" value="compact" class="text-green-600">
                                    <span class="font-medium">กะทัดรัด</span>
                                </div>
                                <div class="text-xs text-gray-600">3x1.5 นิ้ว - ข้อมูลสำคัญ</div>
                                <div class="mt-2 bg-gray-100 rounded p-2 text-xs">
                                    <div class="flex">
                                        <div class="w-4 h-4 bg-gray-300 rounded mr-2"></div>
                                        <div class="flex-1">
                                            <div class="h-1 bg-gray-400 rounded"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="border-2 border-gray-200 rounded-lg p-3 cursor-pointer hover:border-green-500 transition-colors" onclick="selectStickerLayout('minimal')" id="layout-minimal">
                                <div class="flex items-center space-x-2 mb-2">
                                    <input type="radio" name="stickerLayout" value="minimal" class="text-green-600">
                                    <span class="font-medium">เรียบง่าย</span>
                                </div>
                                <div class="text-xs text-gray-600">2x1 นิ้ว - QR + Job No.</div>
                                <div class="mt-2 bg-gray-100 rounded p-2 text-xs">
                                    <div class="flex items-center justify-center">
                                        <div class="w-4 h-4 bg-gray-300 rounded mr-1"></div>
                                        <div class="text-xs">Job</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="previewSticker()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-eye mr-2"></i>ดูตัวอย่าง
                        </button>
                        <button onclick="generateStickers()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-magic mr-2"></i>สร้างสติกเกอร์
                        </button>
                    </div>
                </div>
                
                <div id="stickersContainer" class="mt-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">สติกเกอร์ที่สร้าง</h3>
                    </div>
                    
                    <!-- Sticker Selection Controls -->
                    <div id="stickerControls" class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">เลือกสติกเกอร์:</label>
                                <button onclick="selectAllStickers()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-check-double mr-1"></i>เลือกทั้งหมด
                                </button>
                                <button onclick="deselectAllStickers()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-times mr-1"></i>ยกเลิกทั้งหมด
                                </button>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">สติกเกอร์ที่เลือก:</label>
                                <span id="selectedStickersCount" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-semibold">0</span>
                                <span class="text-gray-600 text-sm">จาก</span>
                                <span id="totalStickersCount" class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-sm font-semibold">0</span>
                                <span class="text-gray-600 text-sm">ใบ</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="printQRStickers('all')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-print mr-2"></i>พิมพ์ทั้งหมด
                                </button>
                                <button onclick="printQRStickers('selected')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                                    <i class="fas fa-print mr-2"></i>พิมพ์ที่เลือก
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stickersGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Stickers will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Receive Section -->
        <div id="receive" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-arrow-down text-blue-600 mr-3"></i>รับเข้าสินค้า
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">สแกน QR Code หรือใส่ Job No. (กด Enter เพื่อโหลดข้อมูล)</label>
                            <div class="flex space-x-2">
                                <div class="flex-1 autocomplete-container">
                                    <input type="text" id="receiveJobNo" placeholder="กรอก Job No. แล้วกด Enter..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onkeyup="handleReceiveJobNoInput(event)" onkeydown="handleReceiveJobNoKeydown(event)">
                                    <div id="receiveJobNoResults" class="autocomplete-list hidden"></div>
                                </div>
                                <button onclick="startBarcodeScanner('receive')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors" title="สแกน QR Code">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label>
                                <input type="date" id="receiveDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">MC</label>
                                <input type="text" id="receiveMC" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">OE</label>
                                <input type="text" id="receiveOE" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสสินค้า</label>
                                <input type="text" id="receiveProductCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า</label>
                                <input type="text" id="receiveProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ขนาด</label>
                                <input type="text" id="receiveSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">สี</label>
                                <input type="text" id="receiveColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อลูกค้า</label>
                                <input type="text" id="receiveCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสฝาประกอบ</label>
                                <input type="text" id="receiveCapCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">บรรจุ/ถุง</label>
                                <input type="number" id="receivePackPerBag" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนถุง</label>
                                <input type="number" id="receiveBagQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="calculateReceiveTotal()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนรับเข้า</label>
                                <input type="number" id="receiveTotal" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">เศษ</label>
                                <input type="number" id="receiveWaste" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <button onclick="saveReceive()" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-save mr-2"></i>บันทึกรับเข้า
                        </button>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">ประวัติรับเข้าล่าสุด</h3>
                        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <div id="receiveHistory" class="space-y-3">
                                <!-- Recent receive history will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Issue Section -->
        <div id="issue" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-arrow-up text-red-600 mr-3"></i>จ่ายออกสินค้า
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">สแกน QR Code หรือใส่ Job No. (กด Enter เพื่อโหลดข้อมูล)</label>
                            <div class="flex space-x-2">
                                <div class="flex-1 autocomplete-container">
                                    <input type="text" id="issueJobNo" placeholder="กรอก Job No. แล้วกด Enter..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" onkeyup="handleIssueJobNoInput(event)" onkeydown="handleIssueJobNoKeydown(event)">
                                    <div id="issueJobNoResults" class="autocomplete-list hidden"></div>
                                </div>
                                <button onclick="startBarcodeScanner('issue')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors" title="สแกน QR Code">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">วันที่</label>
                                <input type="date" id="issueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">MC</label>
                                <input type="text" id="issueMC" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">OE</label>
                                <input type="text" id="issueOE" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสสินค้า</label>
                                <input type="text" id="issueProductCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อสินค้า</label>
                                <input type="text" id="issueProductName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ขนาด</label>
                                <input type="text" id="issueSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">สี</label>
                                <input type="text" id="issueColor" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อลูกค้า</label>
                                <input type="text" id="issueCustomerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">รหัสฝาประกอบ</label>
                                <input type="text" id="issueCapCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">บรรจุ/ถุง</label>
                                <input type="number" id="issuePackPerBag" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนถุง</label>
                                <input type="number" id="issueBagQty" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" onchange="calculateIssueTotal()">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนจ่ายออก</label>
                                <input type="number" id="issueTotal" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">เศษ</label>
                                <input type="number" id="issueWaste" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>
                        
                        <button onclick="saveIssue()" class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg transition-colors font-semibold">
                            <i class="fas fa-save mr-2"></i>บันทึกจ่ายออก
                        </button>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">ประวัติจ่ายออกล่าสุด</h3>
                        <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                            <div id="issueHistory" class="space-y-3">
                                <!-- Recent issue history will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-warehouse text-orange-600 mr-3"></i>สินค้าคงเหลือ
                </h2>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="autocomplete-container">
                            <input type="text" id="searchInventory" placeholder="ค้นหา รหัสสินค้า, Job No., OE..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent w-64" onkeyup="autocompleteInventorySearch()">
                            <div id="searchInventoryResults" class="autocomplete-list hidden"></div>
                        </div>
                        <div>
                            <select id="inventoryGroupBy" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" onchange="loadInventory()">
                                <option value="productCode">จัดกลุ่มตามรหัสสินค้า</option>
                                <option value="jobNo">จัดกลุ่มตาม Job No.</option>
                                <option value="oe">จัดกลุ่มตาม OE</option>
                            </select>
                        </div>
                        <button onclick="searchInventory()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>ค้นหา
                        </button>
                        <div class="relative">
                            <button onclick="toggleInventoryExportMenu()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-file-export mr-2"></i>Export
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            <div id="inventoryExportMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-40">
                                <button onclick="exportInventoryExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)
                                </button>
                                <button onclick="exportInventoryCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv text-blue-600 mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <button onclick="refreshInventory()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">รายการสินค้าทั้งหมด</p>
                                <p class="text-2xl font-bold" id="totalItems">0</p>
                            </div>
                            <i class="fas fa-boxes text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">รับเข้าทั้งหมด</p>
                                <p class="text-2xl font-bold" id="totalReceived">0</p>
                            </div>
                            <i class="fas fa-arrow-down text-3xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-100 text-sm">จ่ายออกทั้งหมด</p>
                                <p class="text-2xl font-bold" id="totalIssued">0</p>
                            </div>
                            <i class="fas fa-arrow-up text-3xl text-red-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">คงเหลือทั้งหมด</p>
                                <p class="text-2xl font-bold" id="totalBalance">0</p>
                            </div>
                            <i class="fas fa-warehouse text-3xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รหัสสินค้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ชื่อสินค้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Job No.</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">OE</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รับเข้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จ่ายออก</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">คงเหลือ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">สถานะ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รายละเอียด</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                            <!-- Inventory will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Audit Trail Section -->
        <div id="auditTrail" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-shield-alt text-red-600 mr-3"></i>Audit Trail - ประวัติการเปลี่ยนแปลง
                </h2>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="autocomplete-container">
                            <input type="text" id="searchAudit" placeholder="ค้นหา ผู้ใช้, การดำเนินการ, รายการ..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" onkeyup="autocompleteAuditSearch()">
                            <div id="searchAuditResults" class="autocomplete-list hidden"></div>
                        </div>
                        <div>
                            <select id="auditActionType" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="all">ทุกการดำเนินการ</option>
                                <option value="create">เพิ่มข้อมูล</option>
                                <option value="update">แก้ไขข้อมูล</option>
                                <option value="delete">ลบข้อมูล</option>
                                <option value="login">เข้าสู่ระบบ</option>
                                <option value="logout">ออกจากระบบ</option>
                                <option value="receive">รับเข้าสินค้า</option>
                                <option value="issue">จ่ายออกสินค้า</option>
                            </select>
                        </div>
                        <div>
                            <select id="auditUserFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="all">ทุกผู้ใช้</option>
                            </select>
                        </div>
                        <div>
                            <input type="date" id="auditDateFrom" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        <div>
                            <input type="date" id="auditDateTo" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        <button onclick="searchAuditTrail()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>ค้นหา
                        </button>
                        <div class="relative">
                            <button onclick="toggleAuditExportMenu()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-file-export mr-2"></i>Export
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            <div id="auditExportMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-40">
                                <button onclick="exportAuditExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)
                                </button>
                                <button onclick="exportAuditCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv text-blue-600 mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <button onclick="refreshAuditTrail()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>รีเฟรช
                        </button>
                    </div>
                </div>

                <!-- Audit Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-100 text-sm">การดำเนินการทั้งหมด</p>
                                <p class="text-2xl font-bold" id="totalAuditActions">0</p>
                            </div>
                            <i class="fas fa-shield-alt text-3xl text-red-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">วันนี้</p>
                                <p class="text-2xl font-bold" id="todayAuditActions">0</p>
                            </div>
                            <i class="fas fa-calendar-day text-3xl text-orange-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm">ผู้ใช้ที่ใช้งาน</p>
                                <p class="text-2xl font-bold" id="activeUsers">0</p>
                            </div>
                            <i class="fas fa-users text-3xl text-yellow-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">การเปลี่ยนแปลงข้อมูล</p>
                                <p class="text-2xl font-bold" id="dataChanges">0</p>
                            </div>
                            <i class="fas fa-edit text-3xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">วันที่/เวลา</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ผู้ใช้</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">การดำเนินการ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รายการ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รายละเอียด</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">IP Address</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody" class="divide-y divide-gray-200">
                            <!-- Audit trail will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div id="history" class="section hidden">
            <div class="bg-white rounded-xl card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history text-purple-600 mr-3"></i>ประวัติการทำงาน
                </h2>
                
                <div class="mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="autocomplete-container">
                            <input type="text" id="searchHistory" placeholder="ค้นหา Job No., สินค้า, ลูกค้า..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onkeyup="autocompleteHistorySearch()">
                            <div id="searchHistoryResults" class="autocomplete-list hidden"></div>
                        </div>
                        <div>
                            <select id="historyType" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="all">ทั้งหมด</option>
                                <option value="receive">รับเข้า</option>
                                <option value="issue">จ่ายออก</option>
                            </select>
                        </div>
                        <div>
                            <input type="date" id="historyDateFrom" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <input type="date" id="historyDateTo" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <button onclick="searchHistory()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>ค้นหา
                        </button>
                        <div class="relative">
                            <button onclick="toggleHistoryExportMenu()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center">
                                <i class="fas fa-file-export mr-2"></i>Export
                                <i class="fas fa-chevron-down ml-2 text-sm"></i>
                            </button>
                            <div id="historyExportMenu" class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-40">
                                <button onclick="exportHistoryExcel()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>Excel (.xlsx)
                                </button>
                                <button onclick="exportHistoryCSV()" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center">
                                    <i class="fas fa-file-csv text-blue-600 mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">วันที่</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ประเภท</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Job No.</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">สินค้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จำนวน</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ผู้ใช้</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-200">
                            <!-- History will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Barcode Scanner Modal -->
    <div id="scannerModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">สแกน QR Code / Barcode</h3>
                <button onclick="stopBarcodeScanner()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="scanner-container mb-4">
                <div id="scanner" class="w-full h-full"></div>
                <div class="scanner-overlay"></div>
            </div>
            
            <div class="text-center">
                <p class="text-sm text-gray-600 mb-4">วางรหัส QR หรือ Barcode ในกรอบสีเขียว</p>
                <button onclick="stopBarcodeScanner()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Sticker Preview Modal -->
    <div id="stickerPreviewModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">ตัวอย่างสติกเกอร์</h3>
                <button onclick="closeStickerPreview()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">รูปแบบ:</span> <span id="previewLayoutName">มาตรฐาน</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <span class="font-medium">จำนวน:</span> <span id="previewQuantity">1</span> ใบ
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="changePreviewLayout('standard')" class="px-3 py-1 text-xs border rounded hover:bg-gray-50">มาตรฐาน</button>
                        <button onclick="changePreviewLayout('compact')" class="px-3 py-1 text-xs border rounded hover:bg-gray-50">กะทัดรัด</button>
                        <button onclick="changePreviewLayout('minimal')" class="px-3 py-1 text-xs border rounded hover:bg-gray-50">เรียบง่าย</button>
                    </div>
                </div>
                
                <div id="stickerPreviewContainer" class="border-2 border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 flex items-center justify-center min-h-[200px]">
                    <div class="text-center text-gray-500">
                        <i class="fas fa-qrcode text-4xl mb-2"></i>
                        <p>เลือก Job No. เพื่อดูตัวอย่างสติกเกอร์</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeStickerPreview()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                    ปิด
                </button>
                <button onclick="confirmAndGenerate()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-check mr-2"></i>ยืนยันและสร้าง
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let items = [];
        let receiveHistory = [];
        let issueHistory = [];
        let users = [];
        let auditTrail = [];
        let currentUser = null;
        let scannerTarget = null;
        let quaggaInitialized = false;
        let isFirebaseReady = false;
        
        // UI State variables
        let currentTab = 'basic';
        let currentItemsPage = 1;
        let itemsPerPage = 25;
        let itemsSortField = null;
        let itemsSortDirection = 'asc';
        let filteredItems = [];
        let selectedStickerLayout = 'standard';

        // Notification System
        const NotificationSystem = {
            // Success notifications
            success: (message, title = 'สำเร็จ!') => {
                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #00b09b, #96c93d)"
                    },
                    stopOnFocus: true,
                    onClick: function(){}
                }).showToast();
            },

            // Error notifications
            error: (message, title = 'เกิดข้อผิดพลาด!') => {
                Toastify({
                    text: message,
                    duration: 4000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #ff5f6d, #ffc371)"
                    },
                    stopOnFocus: true,
                    onClick: function(){}
                }).showToast();
            },

            // Warning notifications
            warning: (message, title = 'คำเตือน!') => {
                Toastify({
                    text: message,
                    duration: 3500,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #f093fb, #f5576c)"
                    },
                    stopOnFocus: true,
                    onClick: function(){}
                }).showToast();
            },

            // Info notifications
            info: (message, title = 'ข้อมูล') => {
                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #4facfe, #00f2fe)"
                    },
                    stopOnFocus: true,
                    onClick: function(){}
                }).showToast();
            },

            // Confirmation dialogs
            confirm: async (message, title = 'ยืนยันการดำเนินการ') => {
                const result = await Swal.fire({
                    title: title,
                    text: message,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก',
                    reverseButtons: true
                });
                return result.isConfirmed;
            },

            // Delete confirmation
            confirmDelete: async (itemName = 'รายการนี้') => {
                const result = await Swal.fire({
                    title: 'ต้องการลบหรือไม่?',
                    text: `คุณต้องการลบ ${itemName} หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ลบ',
                    cancelButtonText: 'ยกเลิก',
                    reverseButtons: true
                });
                return result.isConfirmed;
            },

            // Loading dialog
            loading: (message = 'กำลังดำเนินการ...') => {
                Swal.fire({
                    title: message,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            },

            // Close loading
            closeLoading: () => {
                Swal.close();
            },

            // Input dialog
            input: async (title, placeholder = '', inputType = 'text') => {
                const { value } = await Swal.fire({
                    title: title,
                    input: inputType,
                    inputPlaceholder: placeholder,
                    showCancelButton: true,
                    confirmButtonText: 'ตกลง',
                    cancelButtonText: 'ยกเลิก',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'กรุณากรอกข้อมูล';
                        }
                    }
                });
                return value;
            },

            // Custom notification with actions
            actionNotification: (message, actions = []) => {
                const actionButtons = actions.map(action => 
                    `<button onclick="${action.onClick}" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm mr-2">${action.text}</button>`
                ).join('');

                Toastify({
                    text: `${message}<div class="mt-2">${actionButtons}</div>`,
                    duration: 5000,
                    gravity: "top",
                    position: "right",
                    style: {
                        background: "linear-gradient(to right, #667eea, #764ba2)"
                    },
                    stopOnFocus: true,
                    escapeMarkup: false,
                    onClick: function(){}
                }).showToast();
            },

            // Progress notification
            progress: (message, percentage) => {
                Swal.fire({
                    title: message,
                    html: `
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                        </div>
                        <p class="text-sm text-gray-600">${percentage}% เสร็จสิ้น</p>
                    `,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false
                });
            }
        };

        // Firebase helper functions
        const { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, where, setDoc, getDoc,
                signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } = window.firebaseModules || {};
        
        // Make Firebase functions available globally
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;

        // Wait for Firebase to be ready
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.db && window.auth && window.firebaseModules) {
                        isFirebaseReady = true;
                        updateConnectionStatus(true);
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
                
                // Fallback timeout - if Firebase doesn't load in 5 seconds, continue with localStorage
                setTimeout(() => {
                    if (!isFirebaseReady) {
                        console.warn('Firebase not ready after 5 seconds, using localStorage fallback');
                        updateConnectionStatus(false);
                        resolve();
                    }
                }, 5000);
            });
        }

        // Update connection status indicator
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (statusElement && textElement) {
                if (connected) {
                    statusElement.className = 'realtime-indicator bg-green-400 w-2 h-2 rounded-full';
                    textElement.textContent = 'Real-time Connected';
                } else {
                    statusElement.className = 'realtime-indicator bg-red-400 w-2 h-2 rounded-full';
                    textElement.textContent = 'Connection Lost';
                }
            }
        }

        // Firebase real-time listeners
        let unsubscribeItems = null;
        let unsubscribeReceiveHistory = null;
        let unsubscribeIssueHistory = null;
        let unsubscribeUsers = null;
        let unsubscribeAuditTrail = null;
        
        // Firestore collection paths
        const APP_ID = 'qr-inventory-system';
        const getCollectionPath = (collectionName) => `artifacts/${APP_ID}/public/data/${collectionName}`;
        
        // Auth state
        let currentFirebaseUser = null;

        // Firebase data functions with real-time updates
        async function setupRealtimeListeners() {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                console.log('Firebase not ready, skipping real-time listeners');
                return;
            }
            
            try {
                console.log('Setting up real-time listeners...');
                const { onSnapshot, query, collection, orderBy } = window.firebaseModules;
                
                // Items listener
                unsubscribeItems = onSnapshot(
                    query(collection(window.db, getCollectionPath('items')), orderBy('createdAt', 'desc')),
                    (snapshot) => {
                        items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Items updated:', items.length);
                        
                        // Save to localStorage as backup
                        localStorage.setItem('items', JSON.stringify(items));
                        
                        if (currentUser) {
                            loadItemsTable();
                            loadJobSelects();
                            updateDashboard();
                        }
                        
                        // Show notification for new items (except on initial load)
                        if (snapshot.docChanges().length > 0 && currentUser) {
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === 'added' && change.doc.data().createdBy !== currentUser.email) {
                                    const item = change.doc.data();
                                    NotificationSystem.info(`มีสินค้าใหม่: ${item.productName} (Job: ${item.jobNo})`);
                                }
                            });
                        }
                    },
                    (error) => {
                        console.error('Error in items listener:', error);
                        updateConnectionStatus(false);
                        // Load from localStorage as fallback
                        loadDataFromLocalStorage();
                    }
                );
                
                // Receive History listener
                unsubscribeReceiveHistory = onSnapshot(
                    query(collection(window.db, getCollectionPath('receiveHistory')), orderBy('timestamp', 'desc')),
                    (snapshot) => {
                        receiveHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Receive history updated:', receiveHistory.length);
                        
                        // Save to localStorage as backup
                        localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
                        
                        if (currentUser) {
                            loadReceiveHistory();
                            updateDashboard();
                            if (document.getElementById('inventory') && 
                                document.getElementById('inventory').classList.contains('section') && 
                                !document.getElementById('inventory').classList.contains('hidden')) {
                                loadInventory();
                            }
                        }
                        
                        // Show notification for new receives
                        if (snapshot.docChanges().length > 0 && currentUser) {
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === 'added' && change.doc.data().userEmail !== currentUser.email) {
                                    const receive = change.doc.data();
                                    NotificationSystem.success(`รับเข้าใหม่: ${receive.productName} จำนวน ${receive.total.toLocaleString()} ชิ้น`);
                                }
                            });
                        }
                    },
                    (error) => {
                        console.error('Error in receive history listener:', error);
                        loadDataFromLocalStorage();
                    }
                );
                
                // Issue History listener
                unsubscribeIssueHistory = onSnapshot(
                    query(collection(window.db, getCollectionPath('issueHistory')), orderBy('timestamp', 'desc')),
                    (snapshot) => {
                        issueHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('Issue history updated:', issueHistory.length);
                        
                        // Save to localStorage as backup
                        localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
                        
                        if (currentUser) {
                            loadIssueHistory();
                            updateDashboard();
                            if (document.getElementById('inventory') && 
                                document.getElementById('inventory').classList.contains('section') && 
                                !document.getElementById('inventory').classList.contains('hidden')) {
                                loadInventory();
                            }
                        }
                        
                        // Show notification for new issues
                        if (snapshot.docChanges().length > 0 && currentUser) {
                            snapshot.docChanges().forEach((change) => {
                                if (change.type === 'added' && change.doc.data().userEmail !== currentUser.email) {
                                    const issue = change.doc.data();
                                    NotificationSystem.warning(`จ่ายออกใหม่: ${issue.productName} จำนวน ${issue.total.toLocaleString()} ชิ้น`);
                                }
                            });
                        }
                    },
                    (error) => {
                        console.error('Error in issue history listener:', error);
                        loadDataFromLocalStorage();
                    }
                );
                
                // Users listener (Admin only)
                if (currentUser && currentUser.role === 'admin') {
                    unsubscribeUsers = onSnapshot(
                        collection(window.db, getCollectionPath('users')),
                        (snapshot) => {
                            users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log('Users updated:', users.length);
                            
                            // Save to localStorage as backup
                            localStorage.setItem('users', JSON.stringify(users));
                            
                            if (document.getElementById('userManagement') && 
                                document.getElementById('userManagement').classList.contains('section') && 
                                !document.getElementById('userManagement').classList.contains('hidden')) {
                                loadUsersTable();
                            }
                        },
                        (error) => {
                            console.error('Error in users listener:', error);
                            loadDataFromLocalStorage();
                        }
                    );
                }
                
                // Audit Trail listener (Admin only)
                if (currentUser && currentUser.role === 'admin') {
                    unsubscribeAuditTrail = onSnapshot(
                        query(collection(window.db, getCollectionPath('auditTrail')), orderBy('timestamp', 'desc')),
                        (snapshot) => {
                            auditTrail = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            console.log('Audit trail updated:', auditTrail.length);
                            
                            // Save to localStorage as backup
                            localStorage.setItem('auditTrail', JSON.stringify(auditTrail));
                            
                            if (document.getElementById('auditTrail') && 
                                document.getElementById('auditTrail').classList.contains('section') && 
                                !document.getElementById('auditTrail').classList.contains('hidden')) {
                                loadAuditTrail();
                            }
                        },
                        (error) => {
                            console.error('Error in audit trail listener:', error);
                            loadDataFromLocalStorage();
                        }
                    );
                }
                
                updateConnectionStatus(true);
                console.log('Real-time listeners setup completed');
                
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
                updateConnectionStatus(false);
                // Fallback to localStorage
                loadDataFromLocalStorage();
            }
        }

        // Clean up listeners
        function cleanupRealtimeListeners() {
            if (unsubscribeItems) {
                unsubscribeItems();
                unsubscribeItems = null;
            }
            if (unsubscribeReceiveHistory) {
                unsubscribeReceiveHistory();
                unsubscribeReceiveHistory = null;
            }
            if (unsubscribeIssueHistory) {
                unsubscribeIssueHistory();
                unsubscribeIssueHistory = null;
            }
            if (unsubscribeUsers) {
                unsubscribeUsers();
                unsubscribeUsers = null;
            }
            if (unsubscribeAuditTrail) {
                unsubscribeAuditTrail();
                unsubscribeAuditTrail = null;
            }
            console.log('Real-time listeners cleaned up');
        }

        // Legacy function for fallback
        async function loadDataFromFirebase() {
            if (!isFirebaseReady) return;
            
            try {
                // Load items
                const itemsSnapshot = await getDocs(collection(window.db, 'items'));
                items = itemsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load receive history
                const receiveSnapshot = await getDocs(collection(window.db, 'receiveHistory'));
                receiveHistory = receiveSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load issue history
                const issueSnapshot = await getDocs(collection(window.db, 'issueHistory'));
                issueHistory = issueSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load users
                const usersSnapshot = await getDocs(collection(window.db, 'users'));
                users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load audit trail
                const auditSnapshot = await getDocs(collection(window.db, 'auditTrail'));
                auditTrail = auditSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log('ข้อมูลถูกโหลดจาก Firebase สำเร็จแล้ว!');
                
                // Update UI
                if (currentUser) {
                    loadItemsTable();
                    loadJobSelects();
                    updateDashboard();
                }
            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการโหลดข้อมูลจาก Firebase: ', error);
                // Fallback to localStorage เมื่อเกิดข้อผิดพลาด
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            items = JSON.parse(localStorage.getItem('items') || '[]');
            receiveHistory = JSON.parse(localStorage.getItem('receiveHistory') || '[]');
            issueHistory = JSON.parse(localStorage.getItem('issueHistory') || '[]');
            users = JSON.parse(localStorage.getItem('users') || '[]');
            auditTrail = JSON.parse(localStorage.getItem('auditTrail') || '[]');
            currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        }

        // Function to clean data for Firebase (remove undefined values)
        function cleanDataForFirebase(data) {
            const cleaned = {};
            for (const [key, value] of Object.entries(data)) {
                if (value !== undefined) {
                    if (value === null || value === '') {
                        cleaned[key] = null;
                    } else if (typeof value === 'object' && value !== null) {
                        cleaned[key] = cleanDataForFirebase(value);
                    } else {
                        cleaned[key] = value;
                    }
                }
            }
            return cleaned;
        }

        // Print QR Stickers Function
        function printQRStickers(mode = "all") {
            const container = document.getElementById("stickersContainer");
            if (!container) return;

            let stickers = [];
            if (mode === "all") {
                stickers = container.querySelectorAll(".qr-sticker, .qr-sticker-compact, .qr-sticker-minimal");
            } else if (mode === "selected") {
                stickers = container.querySelectorAll(".qr-sticker.selected, .qr-sticker-compact.selected, .qr-sticker-minimal.selected");
            }

            if (stickers.length === 0) {
                NotificationSystem.warning("ยังไม่มีสติ๊กเกอร์ที่จะพิมพ์");
                return;
            }

            const printWindow = window.open("", "_blank");
            printWindow.document.write(`
                <html>
                <head>
                    <title>พิมพ์สติ๊กเกอร์ QR</title>
                    <style>
                        @page { size: A4; margin: 5mm; }
                        body { 
                            font-family: 'Kanit', sans-serif; 
                            display: flex; 
                            flex-wrap: wrap; 
                            margin: 0;
                            padding: 0;
                        }
                        .qr-sticker {
                            width: 4in;
                            height: 2in;
                            border: 1px solid #ccc;
                            padding: 10px;
                            box-sizing: border-box;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            margin: 5px;
                            page-break-inside: avoid;
                        }
                        .qr-sticker-compact {
                            width: 3in;
                            height: 1.5in;
                            border: 1px solid #ccc;
                            padding: 8px;
                            box-sizing: border-box;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            margin: 5px;
                            page-break-inside: avoid;
                        }
                        .qr-sticker-minimal {
                            width: 2in;
                            height: 1in;
                            border: 1px solid #ccc;
                            padding: 5px;
                            box-sizing: border-box;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            margin: 5px;
                            page-break-inside: avoid;
                        }
                        .selected { outline: 2px dashed red; }
                    </style>
                </head>
                <body>
                    ${Array.from(stickers).map(s => s.outerHTML).join("")}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.onload = () => {
                printWindow.print();
                printWindow.close();
            };
        }

        async function saveItemToFirebase(item) {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                // Fallback to localStorage
                item.id = Date.now() + Math.random();
                items.push(item);
                localStorage.setItem('items', JSON.stringify(items));
                return item;
            }
            
            try {
                const { addDoc, collection } = window.firebaseModules;
                // Clean the item data before saving to Firebase
                const cleanItem = cleanDataForFirebase(item);
                const docRef = await addDoc(collection(window.db, getCollectionPath('items')), cleanItem);
                item.id = docRef.id;
                console.log("ข้อมูลสินค้าถูกเขียนสำเร็จแล้ว! ID:", docRef.id);
                return item;
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเขียนข้อมูลสินค้า: ", error);
                // Fallback to localStorage เมื่อเกิดข้อผิดพลาด
                item.id = Date.now() + Math.random();
                items.push(item);
                localStorage.setItem('items', JSON.stringify(items));
                return item;
            }
        }

        async function saveReceiveToFirebase(receive) {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                receive.id = Date.now() + Math.random();
                receiveHistory.push(receive);
                localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
                return receive;
            }
            
            try {
                const { addDoc, collection } = window.firebaseModules;
                // Clean the receive data before saving to Firebase
                const cleanReceive = cleanDataForFirebase(receive);
                const docRef = await addDoc(collection(window.db, getCollectionPath('receiveHistory')), cleanReceive);
                receive.id = docRef.id;
                console.log("ข้อมูลการรับเข้าถูกเขียนสำเร็จแล้ว! ID:", docRef.id);
                return receive;
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเขียนข้อมูลการรับเข้า: ", error);
                receive.id = Date.now() + Math.random();
                receiveHistory.push(receive);
                localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
                return receive;
            }
        }

        async function saveIssueToFirebase(issue) {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                issue.id = Date.now() + Math.random();
                issueHistory.push(issue);
                localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
                return issue;
            }
            
            try {
                const { addDoc, collection } = window.firebaseModules;
                // Clean the issue data before saving to Firebase
                const cleanIssue = cleanDataForFirebase(issue);
                const docRef = await addDoc(collection(window.db, getCollectionPath('issueHistory')), cleanIssue);
                issue.id = docRef.id;
                console.log("ข้อมูลการจ่ายออกถูกเขียนสำเร็จแล้ว! ID:", docRef.id);
                return issue;
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเขียนข้อมูลการจ่ายออก: ", error);
                issue.id = Date.now() + Math.random();
                issueHistory.push(issue);
                localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
                return issue;
            }
        }

        async function saveUserToFirebase(user) {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                user.id = Date.now() + Math.random();
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                return user;
            }
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                await setDoc(doc(window.db, getCollectionPath('users'), user.uid), user);
                console.log("ข้อมูลผู้ใช้ถูกเขียนสำเร็จแล้ว! UID:", user.uid);
                return user;
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการเขียนข้อมูลผู้ใช้: ", error);
                user.id = Date.now() + Math.random();
                users.push(user);
                localStorage.setItem('users', JSON.stringify(users));
                return user;
            }
        }

        async function deleteItemFromFirebase(itemId) {
            // Always remove from local array first
            items = items.filter(item => item.id !== itemId);
            localStorage.setItem('items', JSON.stringify(items));
            
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                await deleteDoc(doc(window.db, getCollectionPath('items'), itemId));
                console.log("ข้อมูลสินค้าถูกลบสำเร็จแล้ว! ID:", itemId);
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการลบข้อมูลสินค้าจาก Firebase: ", error);
                // Already removed from local storage, so continue
            }
        }

        // User roles and permissions
        const userRoles = {
            admin: {
                name: 'ผู้ดูแลระบบ',
                permissions: ['userManagement', 'itemMaster', 'qrSticker', 'receive', 'issue', 'inventory', 'history', 'auditTrail']
            },
            warehouse: {
                name: 'พนักงานคลัง',
                permissions: ['itemMaster', 'qrSticker', 'receive', 'issue', 'inventory', 'history']
            },
            purchase: {
                name: 'ฝ่ายจัดซื้อ',
                permissions: ['itemMaster', 'inventory', 'history']
            }
        };

        // Check if user is first user (admin)
        async function checkFirstUser() {
            if (!isFirebaseReady || !window.db || !window.firebaseModules) {
                return false;
            }
            
            try {
                const { getDocs, collection } = window.firebaseModules;
                const usersSnapshot = await getDocs(collection(window.db, getCollectionPath('users')));
                return usersSnapshot.empty;
            } catch (error) {
                console.error('Error checking first user:', error);
                return false;
            }
        }

        // Setup Firebase Auth listener
        function setupAuthListener() {
            if (!isFirebaseReady || !window.auth || !window.firebaseModules) {
                console.log('Firebase Auth not ready');
                showLoginSection();
                return;
            }
            
            const { onAuthStateChanged } = window.firebaseModules;
            
            onAuthStateChanged(window.auth, async (firebaseUser) => {
                if (firebaseUser) {
                    console.log('User signed in:', firebaseUser.email);
                    currentFirebaseUser = firebaseUser;
                    
                    // Get user profile from Firestore
                    try {
                        const { getDoc, doc } = window.firebaseModules;
                        const userDoc = await getDoc(doc(window.db, getCollectionPath('users'), firebaseUser.uid));
                        
                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            currentUser = {
                                uid: firebaseUser.uid,
                                email: firebaseUser.email,
                                displayName: firebaseUser.displayName || userData.fullName,
                                fullName: userData.fullName,
                                role: userData.role,
                                status: userData.status || 'active'
                            };
                            
                            if (currentUser.status === 'active') {
                                // Update last login
                                await updateUserLastLogin(firebaseUser.uid);
                                
                                // Log audit action
                                await logAuditAction('login', 'user', currentUser.uid, currentUser.fullName, 
                                    `เข้าสู่ระบบด้วยบทบาท ${userRoles[currentUser.role].name}`);
                                
                                showMainApp();
                            } else {
                                NotificationSystem.error('บัญชีผู้ใช้ถูกระงับ กรุณาติดต่อผู้ดูแลระบบ');
                                await logout();
                            }
                        } else {
                            NotificationSystem.error('ไม่พบข้อมูลผู้ใช้ในระบบ');
                            await logout();
                        }
                    } catch (error) {
                        console.error('Error getting user data:', error);
                        NotificationSystem.error('เกิดข้อผิดพลาดในการโหลดข้อมูลผู้ใช้');
                        await logout();
                    }
                } else {
                    console.log('User signed out');
                    currentFirebaseUser = null;
                    currentUser = null;
                    cleanupRealtimeListeners();
                    showLoginSection();
                }
            });
        }

        async function updateUserLastLogin(uid) {
            try {
                const { updateDoc, doc } = window.firebaseModules;
                await updateDoc(doc(window.db, getCollectionPath('users'), uid), {
                    lastLogin: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error updating last login:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Load data from localStorage first (as backup)
                loadDataFromLocalStorage();
                
                // Wait for Firebase to be ready (with timeout)
                await waitForFirebase();
                
                // Setup Firebase Auth listener
                setupAuthListener();
                
                // Check if this is the first user
                const isFirstUser = await checkFirstUser();
                if (isFirstUser) {
                    document.getElementById('roleSelection').classList.remove('hidden');
                    document.getElementById('registerRole').value = 'admin';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                // Show login section as fallback
                showLoginSection();
            }
        });

        // Login Functions
        async function login(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                NotificationSystem.warning('กรุณากรอกอีเมลและรหัสผ่าน');
                return;
            }

            NotificationSystem.loading('กำลังเข้าสู่ระบบ...');
            
            try {
                if (!isFirebaseReady || !window.auth || !window.firebaseModules) {
                    throw new Error('Firebase ยังไม่พร้อมใช้งาน');
                }

                const { signInWithEmailAndPassword } = window.firebaseModules;
                await signInWithEmailAndPassword(window.auth, email, password);
                
                NotificationSystem.closeLoading();
                // Auth state change will handle the rest
            } catch (error) {
                NotificationSystem.closeLoading();
                console.error("Login Error:", error);
                
                let errorMessage = 'เกิดข้อผิดพลาดในการเข้าสู่ระบบ';
                
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'ไม่พบบัญชีผู้ใช้นี้';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'รหัสผ่านไม่ถูกต้อง';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'มีการพยายามเข้าสู่ระบบมากเกินไป กรุณาลองใหม่ภายหลัง';
                }
                
                NotificationSystem.error(errorMessage);
            }
        }

        // Register function
        async function register(event) {
            event.preventDefault();
            
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const fullName = document.getElementById('registerFullName').value.trim();
            const role = document.getElementById('registerRole').value;

            if (!email || !password || !fullName) {
                NotificationSystem.warning('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            if (password.length < 6) {
                NotificationSystem.warning('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            NotificationSystem.loading('กำลังสร้างบัญชี...');
            
            try {
                if (!isFirebaseReady || !window.auth || !window.firebaseModules) {
                    throw new Error('Firebase ยังไม่พร้อมใช้งาน');
                }

                const { createUserWithEmailAndPassword, updateProfile } = window.firebaseModules;
                
                // Create Firebase Auth user
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
                const firebaseUser = userCredential.user;
                
                // Update display name
                await updateProfile(firebaseUser, {
                    displayName: fullName
                });
                
                // Create user profile in Firestore
                const userData = {
                    uid: firebaseUser.uid,
                    email: firebaseUser.email,
                    fullName: fullName,
                    role: role,
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                await saveUserToFirebase(userData);
                
                NotificationSystem.closeLoading();
                NotificationSystem.success(`สร้างบัญชี ${fullName} เรียบร้อย! กำลังเข้าสู่ระบบ...`);
                
                // Auth state change will handle login
            } catch (error) {
                NotificationSystem.closeLoading();
                console.error("Register Error:", error);
                
                let errorMessage = 'เกิดข้อผิดพลาดในการสร้างบัญชี';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'อีเมลนี้ถูกใช้งานแล้ว';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'รูปแบบอีเมลไม่ถูกต้อง';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'รหัสผ่านไม่ปลอดภัยเพียงพอ';
                }
                
                NotificationSystem.error(errorMessage);
            }
        }

        // Show/hide forms
        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        function showLoginForm() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        // Make functions available globally
        window.login = login;
        window.register = register;
        window.showRegisterForm = showRegisterForm;
        window.showLoginForm = showLoginForm;

        async function logout() {
            const confirmed = await NotificationSystem.confirm('ต้องการออกจากระบบหรือไม่?', 'ออกจากระบบ');
            if (confirmed) {
                NotificationSystem.loading('กำลังออกจากระบบ...');
                try {
                    const userToLog = currentUser;
                    if (userToLog) {
                        await logAuditAction('logout', 'user', userToLog.uid, userToLog.fullName, 'ออกจากระบบ');
                    }
                    
                    // Sign out from Firebase
                    if (window.auth && window.firebaseModules) {
                        const { signOut } = window.firebaseModules;
                        await signOut(window.auth);
                    }
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.info('ออกจากระบบเรียบร้อย');
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการออกจากระบบ');
                    console.error('Logout error:', error);
                }
            }
        }

        function showLoginSection() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainHeader').classList.add('hidden');
            document.getElementById('mainNavigation').classList.add('hidden');
            document.getElementById('quickSearchBar').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('mainHeader').classList.remove('hidden');
            document.getElementById('mainNavigation').classList.remove('hidden');
            document.getElementById('quickSearchBar').classList.remove('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            // Update user display
            document.getElementById('currentUserDisplay').textContent = `ผู้ใช้: ${currentUser.fullName}`;
            document.getElementById('currentRoleDisplay').textContent = `สิทธิ์: ${userRoles[currentUser.role].name}`;
            
            initializeApp();
        }



        function initializeApp() {
            try {
                buildNavigation();
                showSection('itemMaster');
                setCurrentDate();
                
                // Load initial data
                loadItemsTable();
                loadJobSelects();
                updateDashboard();
                loadReceiveHistory();
                loadIssueHistory();
                
                // Setup real-time listeners for Firebase
                if (isFirebaseReady && window.db && window.firebaseModules) {
                    setupRealtimeListeners();
                } else {
                    // Fallback to periodic updates
                    setInterval(() => {
                        updateDashboard();
                    }, 30000); // Update every 30 seconds
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการเริ่มต้นระบบ');
            }
        }

        function buildNavigation() {
            const nav = document.getElementById('navigationMenu');
            nav.innerHTML = '';
            
            const permissions = userRoles[currentUser.role].permissions;
            
            const menuItems = [
                { id: 'userManagement', icon: 'fas fa-users', text: 'จัดการผู้ใช้', permission: 'userManagement' },
                { id: 'itemMaster', icon: 'fas fa-database', text: 'ข้อมูลสินค้า', permission: 'itemMaster' },
                { id: 'qrSticker', icon: 'fas fa-qrcode', text: 'สร้างสติกเกอร์ QR', permission: 'qrSticker' },
                { id: 'receive', icon: 'fas fa-arrow-down', text: 'รับเข้าสินค้า', permission: 'receive' },
                { id: 'issue', icon: 'fas fa-arrow-up', text: 'จ่ายออกสินค้า', permission: 'issue' },
                { id: 'inventory', icon: 'fas fa-warehouse', text: 'สินค้าคงเหลือ', permission: 'inventory' },
                { id: 'history', icon: 'fas fa-history', text: 'ประวัติ', permission: 'history' },
                { id: 'auditTrail', icon: 'fas fa-shield-alt', text: 'Audit Trail', permission: 'auditTrail' }
            ];
            
            menuItems.forEach(item => {
                if (permissions.includes(item.permission)) {
                    const button = document.createElement('button');
                    button.onclick = () => showSection(item.id);
                    button.className = 'nav-btn py-4 px-6 text-gray-700 hover:text-blue-600 border-b-2 border-transparent hover:border-blue-600 transition-colors';
                    button.innerHTML = `<i class="${item.icon} mr-2"></i>${item.text}`;
                    nav.appendChild(button);
                }
            });
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('itemDate').value = today;
            document.getElementById('receiveDate').value = today;
            document.getElementById('issueDate').value = today;
        }

        function showSection(sectionName) {
            try {
                // Check permissions
                if (currentUser && userRoles[currentUser.role]) {
                    const permissions = userRoles[currentUser.role].permissions;
                    if (!permissions.includes(sectionName)) {
                        NotificationSystem.warning('คุณไม่มีสิทธิ์เข้าถึงหน้านี้');
                        return;
                    }
                }
                
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show selected section
                const targetSection = document.getElementById(sectionName);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
                
                // Update navigation
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('border-blue-600', 'text-blue-600');
                });
                
                // Find and highlight the active nav button
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(sectionName)) {
                        btn.classList.add('border-blue-600', 'text-blue-600');
                    }
                });
                
                // Load section-specific data
                if (sectionName === 'history') {
                    loadHistory();
                } else if (sectionName === 'inventory') {
                    loadInventory();
                } else if (sectionName === 'userManagement') {
                    loadUsersTable();
                } else if (sectionName === 'auditTrail') {
                    loadAuditTrail();
                }
            } catch (error) {
                console.error('Error showing section:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการแสดงหน้า');
            }
        }

        // Real-time Dashboard Functions
        function updateDashboard() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            // Calculate totals
            const totalItems = items.length;
            const todayReceive = receiveHistory.filter(r => r.date === today).reduce((sum, r) => sum + (r.total || 0), 0);
            const todayIssue = issueHistory.filter(i => i.date === today).reduce((sum, i) => sum + (i.total || 0), 0);
            const yesterdayReceive = receiveHistory.filter(r => r.date === yesterday).reduce((sum, r) => sum + (r.total || 0), 0);
            const yesterdayIssue = issueHistory.filter(i => i.date === yesterday).reduce((sum, i) => sum + (i.total || 0), 0);
            
            // Calculate inventory and low stock
            const inventory = calculateInventory();
            const lowStock = inventory.filter(item => item.balance > 0 && item.balance < 10).length;
            
            // Update dashboard
            document.getElementById('dashTotalItems').textContent = totalItems.toLocaleString();
            document.getElementById('dashTodayReceive').textContent = todayReceive.toLocaleString();
            document.getElementById('dashTodayIssue').textContent = todayIssue.toLocaleString();
            document.getElementById('dashLowStock').textContent = lowStock.toLocaleString();
            document.getElementById('dashLastUpdate').textContent = now.toLocaleTimeString('th-TH');
            
            // Calculate trends
            const receiveTrend = yesterdayReceive > 0 ? ((todayReceive - yesterdayReceive) / yesterdayReceive * 100).toFixed(1) : '0';
            const issueTrend = yesterdayIssue > 0 ? ((todayIssue - yesterdayIssue) / yesterdayIssue * 100).toFixed(1) : '0';
            
            document.getElementById('dashReceiveTrend').textContent = `${receiveTrend > 0 ? '+' : ''}${receiveTrend}%`;
            document.getElementById('dashIssueTrend').textContent = `${issueTrend > 0 ? '+' : ''}${issueTrend}%`;
        }

        // Quick Search Functions
        function quickSearch() {
            const searchTerm = document.getElementById('quickSearch').value.toLowerCase();
            if (searchTerm.length < 2) {
                hideQuickSearchResults();
                return;
            }
            
            const results = [];
            
            // Search in items
            items.forEach(item => {
                if ((item.productCode && item.productCode.toLowerCase().includes(searchTerm)) ||
                    (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                    (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                    (item.customerName && item.customerName.toLowerCase().includes(searchTerm))) {
                    results.push({
                        type: 'item',
                        title: `${item.productCode} - ${item.productName}`,
                        subtitle: `Job: ${item.jobNo} | ลูกค้า: ${item.customerName}`,
                        data: item
                    });
                }
            });
            
            showQuickSearchResults(results);
        }

        function showQuickSearchResults(results = []) {
            const container = document.getElementById('quickSearchResults');
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            results.slice(0, 10).forEach((result, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `
                    <div class="font-semibold text-sm">${result.title}</div>
                    <div class="text-xs text-gray-600">${result.subtitle}</div>
                `;
                div.onclick = () => selectQuickSearchResult(result);
                container.appendChild(div);
            });
            
            container.classList.remove('hidden');
        }

        function hideQuickSearchResults() {
            document.getElementById('quickSearchResults').classList.add('hidden');
        }

        function selectQuickSearchResult(result) {
            if (result.type === 'item') {
                // Navigate to item details or fill form
                document.getElementById('quickSearch').value = `${result.data.productCode} - ${result.data.productName}`;
                hideQuickSearchResults();
                
                // You can add logic here to navigate to specific section or fill forms
                showSection('itemMaster');
            }
        }

        // Autocomplete Functions
        function autocompleteJobNo(inputId) {
            const searchTerm = document.getElementById(inputId).value.toLowerCase();
            const resultsId = inputId + 'Results';
            
            if (searchTerm.length < 1) {
                document.getElementById(resultsId).classList.add('hidden');
                return;
            }
            
            const results = items.filter(item => 
                item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)
            ).slice(0, 5);
            
            showAutocompleteResults(resultsId, results, (item) => {
                document.getElementById(inputId).value = item.jobNo;
                document.getElementById(resultsId).classList.add('hidden');
            });
        }

        function autocompleteInventorySearch() {
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            
            if (searchTerm.length < 2) {
                document.getElementById('searchInventoryResults').classList.add('hidden');
                return;
            }
            
            const results = items.filter(item => 
                (item.productCode && item.productCode.toLowerCase().includes(searchTerm)) ||
                (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                (item.oe && item.oe.toLowerCase().includes(searchTerm)) ||
                (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                (item.customerName && item.customerName.toLowerCase().includes(searchTerm))
            ).slice(0, 8);
            
            showAutocompleteResults('searchInventoryResults', results, (item) => {
                document.getElementById('searchInventory').value = item.productCode || item.jobNo;
                document.getElementById('searchInventoryResults').classList.add('hidden');
                searchInventory();
            });
        }

        function autocompleteHistorySearch() {
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
            
            if (searchTerm.length < 2) {
                document.getElementById('searchHistoryResults').classList.add('hidden');
                return;
            }
            
            const allHistory = [...receiveHistory, ...issueHistory];
            const results = allHistory.filter(item => 
                (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                (item.customerName && item.customerName.toLowerCase().includes(searchTerm))
            ).slice(0, 8);
            
            showAutocompleteResults('searchHistoryResults', results, (item) => {
                document.getElementById('searchHistory').value = item.jobNo;
                document.getElementById('searchHistoryResults').classList.add('hidden');
                searchHistory();
            });
        }

        function showAutocompleteResults(containerId, results, onSelect) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.innerHTML = `
                    <div class="font-semibold text-sm">${item.jobNo || item.productCode} - ${item.productName}</div>
                    <div class="text-xs text-gray-600">${item.customerName || ''}</div>
                `;
                div.onclick = () => onSelect(item);
                container.appendChild(div);
            });
            
            container.classList.remove('hidden');
        }

        // Barcode Scanner Functions
        function startBarcodeScanner(target = null) {
            scannerTarget = target;
            document.getElementById('scannerModal').classList.remove('hidden');
            
            if (!quaggaInitialized) {
                initializeQuagga();
            } else {
                Quagga.start();
            }
        }

        function stopBarcodeScanner() {
            document.getElementById('scannerModal').classList.add('hidden');
            if (quaggaInitialized) {
                Quagga.stop();
            }
        }

        function initializeQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner'),
                    constraints: {
                        width: 480,
                        height: 320,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader"
                    ]
                }
            }, function(err) {
                if (err) {
                    console.log(err);
                    alert('ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตใช้กล้อง');
                    stopBarcodeScanner();
                    return;
                }
                quaggaInitialized = true;
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                handleScannedCode(code);
                stopBarcodeScanner();
            });
        }

        function handleScannedCode(code) {
            if (scannerTarget === 'receive') {
                document.getElementById('receiveJobNo').value = code;
                loadReceiveData();
            } else if (scannerTarget === 'issue') {
                document.getElementById('issueJobNo').value = code;
                loadIssueData();
            } else {
                // Quick search
                document.getElementById('quickSearch').value = code;
                quickSearch();
            }
        }

        // User Management Functions
        function showAddUserForm() {
            document.getElementById('addUserForm').classList.remove('hidden');
        }

        function hideAddUserForm() {
            document.getElementById('addUserForm').classList.add('hidden');
            clearUserForm();
        }

        function clearUserForm() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newFullName').value = '';
            document.getElementById('newUserRole').value = 'warehouse';
            document.getElementById('newEmail').value = '';
            document.getElementById('newPhone').value = '';
        }

        async function saveUser() {
            const user = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                fullName: document.getElementById('newFullName').value,
                role: document.getElementById('newUserRole').value,
                email: document.getElementById('newEmail').value,
                phone: document.getElementById('newPhone').value,
                status: 'active',
                lastLogin: null,
                createdAt: new Date().toISOString()
            };

            if (!user.username || !user.password || !user.fullName) {
                NotificationSystem.warning('กรุณากรอกข้อมูลให้ครบถ้วน');
                return;
            }

            // Check if username already exists
            if (users.find(u => u.username === user.username)) {
                NotificationSystem.error('ชื่อผู้ใช้นี้มีอยู่แล้ว');
                return;
            }

            NotificationSystem.loading('กำลังบันทึกผู้ใช้...');

            try {
                await saveUserToFirebase(user);
                
                // Log audit action
                await logAuditAction('create', 'user', user.id, user.fullName, 
                    `เพิ่มผู้ใช้ใหม่ บทบาท: ${userRoles[user.role].name}`, null, { ...user, password: '[HIDDEN]' });
                
                loadUsersTable();
                hideAddUserForm();
                NotificationSystem.closeLoading();
                NotificationSystem.success(`เพิ่มผู้ใช้ ${user.fullName} เรียบร้อย`);
            } catch (error) {
                NotificationSystem.closeLoading();
                NotificationSystem.error('เกิดข้อผิดพลาดในการบันทึกผู้ใช้');
            }
        }

        function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = user.status === 'active' ? 'ใช้งาน' : 'ระงับ';
                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString('th-TH') : 'ยังไม่เคยเข้าใช้';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium">${user.username}</td>
                    <td class="px-4 py-3 text-sm">${user.fullName}</td>
                    <td class="px-4 py-3 text-sm">${userRoles[user.role].name}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${lastLogin}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="toggleUserStatus(${user.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-${user.status === 'active' ? 'ban' : 'check'}"></i>
                        </button>
                        <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleUserStatus(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.id !== currentUser.id) {
                const action = user.status === 'active' ? 'ระงับ' : 'เปิดใช้งาน';
                const confirmed = await NotificationSystem.confirm(
                    `ต้องการ${action}บัญชี ${user.fullName} หรือไม่?`,
                    `${action}บัญชีผู้ใช้`
                );
                
                if (confirmed) {
                    const oldStatus = user.status;
                    user.status = user.status === 'active' ? 'inactive' : 'active';
                    
                    // Log audit action
                    await logAuditAction('update', 'user', user.id, user.fullName, 
                        `${action}บัญชีผู้ใช้`, { status: oldStatus }, { status: user.status });
                    
                    localStorage.setItem('users', JSON.stringify(users));
                    loadUsersTable();
                    NotificationSystem.success(`${action}บัญชี ${user.fullName} เรียบร้อย`);
                }
            } else {
                NotificationSystem.warning('ไม่สามารถเปลี่ยนสถานะของตัวเองได้');
            }
        }

        async function deleteUser(userId) {
            if (userId === currentUser.id) {
                NotificationSystem.warning('ไม่สามารถลบบัญชีของตัวเองได้');
                return;
            }
            
            const user = users.find(u => u.id === userId);
            const confirmed = await NotificationSystem.confirmDelete(`บัญชี ${user?.fullName || 'ผู้ใช้นี้'}`);
            
            if (confirmed) {
                // Log audit action before deletion
                await logAuditAction('delete', 'user', user.id, user.fullName, 
                    `ลบบัญชีผู้ใช้`, { ...user, password: '[HIDDEN]' }, null);
                
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('users', JSON.stringify(users));
                loadUsersTable();
                NotificationSystem.success(`ลบบัญชี ${user?.fullName || 'ผู้ใช้'} เรียบร้อย`);
            }
        }

        // Item Master Functions
        function showAddItemForm() {
            document.getElementById('addItemForm').classList.remove('hidden');
        }

        function hideAddItemForm() {
            document.getElementById('addItemForm').classList.add('hidden');
            clearItemForm();
            
            // Reset editing state
            window.editingItemId = undefined;
            window.editingItemOriginal = undefined;
            
            // Reset form title and button text
            document.querySelector('#addItemForm h3').textContent = 'เพิ่มสินค้าใหม่';
            document.querySelector('#addItemForm button[onclick="saveItem()"]').innerHTML = '<i class="fas fa-save mr-2"></i>บันทึก';
        }

        function clearItemForm() {
            const form = document.getElementById('addItemForm');
            form.querySelectorAll('input').forEach(input => {
                if (input.type !== 'date') {
                    input.value = '';
                } else {
                    input.value = new Date().toISOString().split('T')[0];
                }
            });
            // Reset to first tab
            switchTab('basic');
        }

        // Tab Navigation Functions
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'TabContent').classList.remove('hidden');
            
            // Add active class to selected tab
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            
            currentTab = tabName;
            updateTabNavigation();
        }

        function updateTabNavigation() {
            const tabs = ['basic', 'product', 'customer', 'production'];
            const currentIndex = tabs.indexOf(currentTab);
            
            const prevBtn = document.getElementById('prevTabBtn');
            const nextBtn = document.getElementById('nextTabBtn');
            
            // Show/hide previous button
            if (currentIndex === 0) {
                prevBtn.classList.add('hidden');
            } else {
                prevBtn.classList.remove('hidden');
            }
            
            // Update next button text
            if (currentIndex === tabs.length - 1) {
                nextBtn.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึก';
                nextBtn.onclick = saveItem;
            } else {
                nextBtn.innerHTML = 'ถัดไป<i class="fas fa-chevron-right ml-2"></i>';
                nextBtn.onclick = nextTab;
            }
        }

        function nextTab() {
            const tabs = ['basic', 'product', 'customer', 'production'];
            const currentIndex = tabs.indexOf(currentTab);
            
            if (currentIndex < tabs.length - 1) {
                switchTab(tabs[currentIndex + 1]);
            }
        }

        function previousTab() {
            const tabs = ['basic', 'product', 'customer', 'production'];
            const currentIndex = tabs.indexOf(currentTab);
            
            if (currentIndex > 0) {
                switchTab(tabs[currentIndex - 1]);
            }
        }

        function calculateBagQty() {
            const productionQty = parseInt(document.getElementById('itemProductionQty').value) || 0;
            const packPerBag = parseInt(document.getElementById('itemPackPerBag').value) || 0;
            
            if (packPerBag > 0) {
                const bagQty = Math.ceil(productionQty / packPerBag);
                document.getElementById('itemBagQty').value = bagQty;
            }
            
            updateCalculatedTotal();
        }

        function updateCalculatedTotal() {
            const bagQty = parseInt(document.getElementById('itemBagQty').value) || 0;
            const packPerBag = parseInt(document.getElementById('itemPackPerBag').value) || 0;
            const total = bagQty * packPerBag;
            
            document.getElementById('calculatedTotal').textContent = total.toLocaleString();
        }

        // Auto-calculate when values change
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('itemProductionQty')?.addEventListener('input', calculateBagQty);
            document.getElementById('itemPackPerBag')?.addEventListener('input', calculateBagQty);
            document.getElementById('itemBagQty')?.addEventListener('input', updateCalculatedTotal);
        });

        async function saveItem() {
            const isEditing = window.editingItemId !== undefined;
            
            const item = {
                date: document.getElementById('itemDate').value,
                mc: document.getElementById('itemMC').value,
                jobNo: document.getElementById('itemJobNo').value,
                dueDate: document.getElementById('itemDueDate').value,
                oe: document.getElementById('itemOE').value,
                productCode: document.getElementById('itemProductCode').value,
                productName: document.getElementById('itemProductName').value,
                size: document.getElementById('itemSize').value,
                color: document.getElementById('itemColor').value,
                customerCode: document.getElementById('itemCustomerCode').value,
                customerName: document.getElementById('itemCustomerName').value,
                logo: document.getElementById('itemLogo').value,
                material: document.getElementById('itemMaterial').value,
                capCode: document.getElementById('itemCapCode').value,
                productionQty: parseInt(document.getElementById('itemProductionQty').value) || 0,
                packPerBag: parseInt(document.getElementById('itemPackPerBag').value) || 0,
                bagQty: parseInt(document.getElementById('itemBagQty').value) || 0,
                waste: parseInt(document.getElementById('itemWaste').value) || 0
            };

            if (!item.jobNo || !item.productName) {
                NotificationSystem.error("กรุณากรอก Job No. และชื่อสินค้า");
                return;
            }

            // Check for duplicate Job No. (exclude current item when editing)
            const existingByJobNo = items.find(i => 
                i.jobNo && 
                i.jobNo.toLowerCase() === item.jobNo.toLowerCase() && 
                (!isEditing || i.id !== window.editingItemId)
            );
            
            if (existingByJobNo) {
                NotificationSystem.error(`Job No. "${item.jobNo}" มีอยู่แล้วในระบบ`);
                return;
            }

            NotificationSystem.loading(isEditing ? 'กำลังบันทึกการแก้ไข...' : 'กำลังบันทึกสินค้า...');

            try {
                if (isEditing) {
                    // Update existing item
                    const existingItem = items.find(i => i.id === window.editingItemId);
                    const oldData = { ...existingItem };
                    
                    // Preserve original metadata and ensure no undefined values
                    item.id = window.editingItemId;
                    item.createdBy = existingItem.createdBy || (currentUser ? currentUser.email : 'system');
                    item.createdAt = existingItem.createdAt || new Date().toISOString();
                    item.updatedBy = currentUser ? currentUser.email : 'system';
                    item.updatedAt = new Date().toISOString();
                    
                    // Update in array
                    const itemIndex = items.findIndex(i => i.id === window.editingItemId);
                    items[itemIndex] = item;
                    
                    // Save to storage
                    localStorage.setItem('items', JSON.stringify(items));
                    
                    // Save to Firebase if available
                    if (isFirebaseReady && window.db && window.firebaseModules) {
                        try {
                            const { updateDoc, doc } = window.firebaseModules;
                            // Clean item data before saving to Firebase
                            const cleanItem = cleanDataForFirebase(item);
                            await updateDoc(doc(window.db, getCollectionPath('items'), window.editingItemId), cleanItem);
                        } catch (error) {
                            console.error('Error updating item in Firebase:', error);
                        }
                    }
                    
                    // Log audit action
                    await logAuditAction('update', 'item', item.id, item.productName, 
                        `แก้ไขสินค้า Job No: ${item.jobNo}`, oldData, item);
                    
                    NotificationSystem.success(`แก้ไขสินค้า ${item.productName} เรียบร้อย`);
                } else {
                    // Create new item - ensure no undefined values
                    item.createdBy = currentUser ? currentUser.email : 'system';
                    item.createdAt = new Date().toISOString();
                    item.updatedBy = null;
                    item.updatedAt = null;
                    
                    await saveItemToFirebase(item);
                    
                    // Log audit action
                    await logAuditAction('create', 'item', item.id, item.productName, `เพิ่มสินค้าใหม่ Job No: ${item.jobNo}`, null, item);
                    
                    NotificationSystem.success(`บันทึกสินค้า ${item.productName} เรียบร้อย`);
                }
                
                // Reset editing state
                window.editingItemId = undefined;
                window.editingItemOriginal = undefined;
                
                loadItemsTable();
                loadJobSelects();
                hideAddItemForm();
                updateDashboard();
                
                NotificationSystem.closeLoading();
            } catch (error) {
                NotificationSystem.closeLoading();
                NotificationSystem.error("เกิดข้อผิดพลาดในการบันทึกสินค้า: " + error.message);
            }
        }
        
        // Make saveItem available globally
        window.saveItem = saveItem;

        function loadItemsTable() {
            // Apply search filter
            const searchTerm = document.getElementById('itemTableSearch')?.value.toLowerCase() || '';
            filteredItems = items.filter(item => 
                (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                (item.productCode && item.productCode.toLowerCase().includes(searchTerm)) ||
                (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                (item.customerName && item.customerName.toLowerCase().includes(searchTerm))
            );

            // Apply sorting
            if (itemsSortField) {
                filteredItems.sort((a, b) => {
                    let aVal = a[itemsSortField] || '';
                    let bVal = b[itemsSortField] || '';
                    
                    // Handle dates
                    if (itemsSortField === 'dueDate' || itemsSortField === 'date') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return itemsSortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return itemsSortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Calculate pagination
            const totalItems = filteredItems.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentItemsPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const pageItems = filteredItems.slice(startIndex, endIndex);

            // Update table
            const tbody = document.getElementById('itemsTableBody');
            tbody.innerHTML = '';

            if (pageItems.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-3xl mb-2"></i>
                        <div>ไม่พบข้อมูลสินค้า</div>
                    </td>
                `;
                tbody.appendChild(row);
            } else {
                pageItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium">${item.jobNo || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.productCode || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.productName || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.customerName || '-'}</td>
                        <td class="px-4 py-3 text-sm">${item.dueDate || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            ${currentUser && currentUser.role === 'admin' ? `
                            <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="แก้ไข">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800" title="ลบ">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : `
                            <button onclick="viewItemDetail(${item.id})" class="text-green-600 hover:text-green-800" title="ดูรายละเอียด">
                                <i class="fas fa-eye"></i>
                            </button>
                            `}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Update pagination info
            updateItemsPaginationInfo(startIndex + 1, endIndex, totalItems, totalPages);
            generateItemsPagination(totalPages);
        }

        function updateItemsPaginationInfo(from, to, total, totalPages) {
            document.getElementById('itemsShowingFrom').textContent = from;
            document.getElementById('itemsShowingTo').textContent = to;
            document.getElementById('itemsTotal').textContent = total;
            document.getElementById('itemsCurrentPage').textContent = currentItemsPage;
            document.getElementById('itemsTotalPages').textContent = totalPages;
        }

        function generateItemsPagination(totalPages) {
            const container = document.getElementById('itemsPagination');
            container.innerHTML = '';

            // Previous button state
            const prevBtn = document.getElementById('itemsPrevBtn');
            prevBtn.disabled = currentItemsPage === 1;

            // Next button state
            const nextBtn = document.getElementById('itemsNextBtn');
            nextBtn.disabled = currentItemsPage === totalPages || totalPages === 0;

            // Generate page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentItemsPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // First page
            if (startPage > 1) {
                addPageButton(container, 1);
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-3 py-2 text-gray-500';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(container, i);
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-3 py-2 text-gray-500';
                    ellipsis.textContent = '...';
                    container.appendChild(ellipsis);
                }
                addPageButton(container, totalPages);
            }
        }

        function addPageButton(container, pageNum) {
            const button = document.createElement('button');
            button.className = `px-3 py-2 text-sm font-medium rounded-lg transition-colors ${
                pageNum === currentItemsPage 
                    ? 'bg-blue-600 text-white' 
                    : 'text-gray-700 hover:bg-gray-100'
            }`;
            button.textContent = pageNum;
            button.onclick = () => goToItemsPage(pageNum);
            container.appendChild(button);
        }

        function goToItemsPage(page) {
            currentItemsPage = page;
            loadItemsTable();
        }

        function previousItemsPage() {
            if (currentItemsPage > 1) {
                currentItemsPage--;
                loadItemsTable();
            }
        }

        function nextItemsPage() {
            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            if (currentItemsPage < totalPages) {
                currentItemsPage++;
                loadItemsTable();
            }
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentItemsPage = 1;
            loadItemsTable();
        }

        function searchItemTable() {
            currentItemsPage = 1;
            loadItemsTable();
        }

        function clearItemTableSearch() {
            document.getElementById('itemTableSearch').value = '';
            searchItemTable();
        }

        function sortItemTable(field) {
            if (itemsSortField === field) {
                itemsSortDirection = itemsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                itemsSortField = field;
                itemsSortDirection = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort ml-1 text-gray-400';
            });

            const sortIcon = document.getElementById(`sort-${field}`);
            if (sortIcon) {
                sortIcon.className = `fas fa-sort-${itemsSortDirection === 'asc' ? 'up' : 'down'} ml-1 text-blue-600`;
            }

            loadItemsTable();
        }

        async function editItem(id) {
            // Check admin permission
            if (!currentUser || currentUser.role !== 'admin') {
                NotificationSystem.error('เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถแก้ไขข้อมูลสินค้าได้');
                return;
            }

            const item = items.find(i => i.id === id);
            if (!item) {
                NotificationSystem.error('ไม่พบข้อมูลสินค้า');
                return;
            }

            // Fill form with existing data
            document.getElementById('itemDate').value = item.date || '';
            document.getElementById('itemMC').value = item.mc || '';
            document.getElementById('itemJobNo').value = item.jobNo || '';
            document.getElementById('itemDueDate').value = item.dueDate || '';
            document.getElementById('itemOE').value = item.oe || '';
            document.getElementById('itemProductCode').value = item.productCode || '';
            document.getElementById('itemProductName').value = item.productName || '';
            document.getElementById('itemSize').value = item.size || '';
            document.getElementById('itemColor').value = item.color || '';
            document.getElementById('itemCustomerCode').value = item.customerCode || '';
            document.getElementById('itemCustomerName').value = item.customerName || '';
            document.getElementById('itemLogo').value = item.logo || '';
            document.getElementById('itemMaterial').value = item.material || '';
            document.getElementById('itemCapCode').value = item.capCode || '';
            document.getElementById('itemProductionQty').value = item.productionQty || 0;
            document.getElementById('itemPackPerBag').value = item.packPerBag || 0;
            document.getElementById('itemBagQty').value = item.bagQty || 0;
            document.getElementById('itemWaste').value = item.waste || 0;

            // Store the item ID for updating
            window.editingItemId = id;
            window.editingItemOriginal = { ...item };

            // Show form
            showAddItemForm();
            
            // Change form title and button text
            document.querySelector('#addItemForm h3').textContent = 'แก้ไขข้อมูลสินค้า';
            document.querySelector('#addItemForm button[onclick="saveItem()"]').innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกการแก้ไข';
            
            NotificationSystem.info(`กำลังแก้ไขสินค้า: ${item.productName}`);
        }

        function viewItemDetail(id) {
            const item = items.find(i => i.id === id);
            if (!item) {
                NotificationSystem.error('ไม่พบข้อมูลสินค้า');
                return;
            }

            const detailsHtml = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div><strong>วันที่:</strong> ${item.date || '-'}</div>
                    <div><strong>MC:</strong> ${item.mc || '-'}</div>
                    <div><strong>Job No.:</strong> ${item.jobNo || '-'}</div>
                    <div><strong>กำหนดส่ง:</strong> ${item.dueDate || '-'}</div>
                    <div><strong>OE:</strong> ${item.oe || '-'}</div>
                    <div><strong>รหัสสินค้า:</strong> ${item.productCode || '-'}</div>
                    <div class="md:col-span-2"><strong>ชื่อสินค้า:</strong> ${item.productName || '-'}</div>
                    <div><strong>ขนาด:</strong> ${item.size || '-'}</div>
                    <div><strong>สี:</strong> ${item.color || '-'}</div>
                    <div><strong>รหัสลูกค้า:</strong> ${item.customerCode || '-'}</div>
                    <div><strong>ชื่อลูกค้า:</strong> ${item.customerName || '-'}</div>
                    <div><strong>โลโก้:</strong> ${item.logo || '-'}</div>
                    <div><strong>วัสดุประกอบ:</strong> ${item.material || '-'}</div>
                    <div><strong>รหัสฝาประกอบ:</strong> ${item.capCode || '-'}</div>
                    <div><strong>จำนวนผลิต:</strong> ${(item.productionQty || 0).toLocaleString()} ชิ้น</div>
                    <div><strong>บรรจุ/ถุง:</strong> ${(item.packPerBag || 0).toLocaleString()} ชิ้น</div>
                    <div><strong>จำนวนถุง:</strong> ${(item.bagQty || 0).toLocaleString()} ถุง</div>
                    <div><strong>เศษ:</strong> ${(item.waste || 0).toLocaleString()} ชิ้น</div>
                    <div class="md:col-span-2 pt-2 border-t">
                        <div class="text-sm text-gray-600">
                            <div><strong>สร้างโดย:</strong> ${item.createdBy || '-'}</div>
                            <div><strong>สร้างเมื่อ:</strong> ${item.createdAt ? new Date(item.createdAt).toLocaleString('th-TH') : '-'}</div>
                        </div>
                    </div>
                </div>
            `;

            Swal.fire({
                title: `รายละเอียดสินค้า`,
                html: detailsHtml,
                width: '700px',
                confirmButtonText: 'ปิด',
                showCancelButton: false
            });
        }

        async function deleteItem(id) {
            // Check admin permission
            if (!currentUser || currentUser.role !== 'admin') {
                NotificationSystem.error('เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถลบข้อมูลสินค้าได้');
                return;
            }

            const item = items.find(i => i.id === id);
            const confirmed = await NotificationSystem.confirmDelete(`สินค้า ${item?.productName || 'รายการนี้'}`);
            
            if (confirmed) {
                NotificationSystem.loading('กำลังลบสินค้า...');
                
                try {
                    // Log audit action before deletion
                    await logAuditAction('delete', 'item', item.id, item.productName, `ลบสินค้า Job No: ${item.jobNo}`, item, null);
                    
                    await deleteItemFromFirebase(id);
                    loadItemsTable();
                    loadJobSelects();
                    updateDashboard();
                    NotificationSystem.closeLoading();
                    NotificationSystem.success(`ลบสินค้า ${item?.productName || 'รายการ'} เรียบร้อย`);
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการลบสินค้า');
                }
            }
        }

        function loadJobSelects() {
            const select = document.getElementById('qrJobSelect');
            select.innerHTML = '<option value="">-- เลือก Job No. --</option>';
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.jobNo;
                option.textContent = `${item.jobNo} - ${item.productName}`;
                select.appendChild(option);
            });
        }

        // QR Sticker Functions
        function loadJobDetails() {
            const jobNo = document.getElementById('qrJobSelect').value;
            const item = items.find(item => item.jobNo === jobNo);
            
            if (item) {
                document.getElementById('jobDetails').classList.remove('hidden');
                document.getElementById('detailDate').textContent = item.date;
                document.getElementById('detailMC').textContent = item.mc;
                document.getElementById('detailOE').textContent = item.oe;
                document.getElementById('detailProductCode').textContent = item.productCode;
                document.getElementById('detailProductName').textContent = item.productName;
                document.getElementById('detailSize').textContent = item.size;
                document.getElementById('detailColor').textContent = item.color;
                document.getElementById('detailCustomerName').textContent = item.customerName;
                document.getElementById('detailCapCode').textContent = item.capCode;
                document.getElementById('detailPackPerBag').textContent = item.packPerBag;
                document.getElementById('detailBagQty').textContent = item.bagQty || 0;
                
                // Auto-fill total bags from data
                document.getElementById('totalBags').value = item.bagQty || 0;
            } else {
                document.getElementById('jobDetails').classList.add('hidden');
                document.getElementById('totalBags').value = '';
            }
        }

        function useDataBagQty() {
            const jobNo = document.getElementById('qrJobSelect').value;
            const item = items.find(item => item.jobNo === jobNo);
            
            if (item && item.bagQty) {
                document.getElementById('totalBags').value = item.bagQty;
                document.getElementById('totalBags').readOnly = true;
                NotificationSystem.success(`ใช้จำนวนถุงจากข้อมูล: ${item.bagQty} ถุง`);
            } else {
                NotificationSystem.warning('ไม่พบข้อมูลจำนวนถุงในรายการนี้');
            }
        }

        function customBagQty() {
            document.getElementById('totalBags').readOnly = false;
            document.getElementById('totalBags').focus();
            NotificationSystem.info('สามารถกำหนดจำนวนถุงเองได้แล้ว');
        }

        // Sticker Layout Functions
        function selectStickerLayout(layout) {
            selectedStickerLayout = layout;
            
            // Update visual selection
            document.querySelectorAll('[id^="layout-"]').forEach(div => {
                div.classList.remove('border-green-500', 'bg-green-50');
                div.classList.add('border-gray-200');
            });
            
            document.getElementById(`layout-${layout}`).classList.add('border-green-500', 'bg-green-50');
            document.getElementById(`layout-${layout}`).classList.remove('border-gray-200');
            
            // Update radio button
            document.querySelector(`input[value="${layout}"]`).checked = true;
        }

        function previewSticker() {
            const jobNo = document.getElementById('qrJobSelect').value;
            const totalBags = parseInt(document.getElementById('totalBags').value) || 1;
            const item = items.find(i => i.jobNo === jobNo);

            if (!item) {
                NotificationSystem.warning('กรุณาเลือก Job No. ก่อนดูตัวอย่าง');
                return;
            }

            // Update preview info
            document.getElementById('previewLayoutName').textContent = getStickerLayoutName(selectedStickerLayout);
            document.getElementById('previewQuantity').textContent = totalBags.toLocaleString();

            // Generate preview
            generateStickerPreview(item, selectedStickerLayout);
            
            // Show modal
            document.getElementById('stickerPreviewModal').classList.remove('hidden');
        }

        function getStickerLayoutName(layout) {
            const names = {
                'standard': 'มาตรฐาน',
                'compact': 'กะทัดรัด',
                'minimal': 'เรียบง่าย'
            };
            return names[layout] || 'มาตรฐาน';
        }

        function generateStickerPreview(item, layout) {
            const container = document.getElementById('stickerPreviewContainer');
            const qrData = `${item.jobNo}`;

            QRCode.toDataURL(qrData, { width: layout === 'minimal' ? 60 : 80 }, function (err, url) {
                if (err) {
                    container.innerHTML = '<div class="text-red-500">เกิดข้อผิดพลาดในการสร้าง QR Code</div>';
                    return;
                }

                let stickerHTML = '';
                let stickerClass = '';
                
                switch (layout) {
                    case 'standard':
                        stickerClass = 'qr-sticker';
                        stickerHTML = `
                            <div class="${stickerClass} border-2 border-gray-300 bg-white rounded-lg shadow-lg">
                                <div style="display: flex; width: 100%; height: 100%;">
                                    <!-- QR Code Section (Left) -->
                                    <div style="flex-shrink: 0; width: 1.2in; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 0.15in;">
                                        <img src="${url}" style="width: 0.9in; height: 0.9in; border: 1px solid #ddd; border-radius: 4px;" />
                                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-top: 4px; color: #333; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${item.jobNo}</div>
                                        <div style="font-size: 7px; text-align: center; margin-top: 2px; color: #666;">MC: ${item.mc || '-'}</div>
                                    </div>
                                    
                                    <!-- Content Section (Right) -->
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; font-size: 9px; line-height: 1.3;">
                                        <div>
                                            <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px; color: #1a365d; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">${item.productName}</div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
                                                <div style="color: #555; font-size: 8px;"><strong>วันที่:</strong> ${item.date || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>กำหนดส่ง:</strong> ${item.dueDate || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>รหัส:</strong> ${item.productCode || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>OE:</strong> ${item.oe || '-'}</div>
                                            </div>
                                            
                                            <div style="margin-bottom: 3px;">
                                                <div style="color: #555; font-size: 8px; margin-bottom: 1px;"><strong>ขนาด:</strong> ${item.size || '-'} <strong>สี:</strong> ${item.color || '-'}</div>
                                                <div style="color: #555; font-size: 8px; margin-bottom: 1px;"><strong>ลูกค้า:</strong> ${item.customerName || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>บรรจุ/ถุง:</strong> ${item.packPerBag || 0} ชิ้น</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bag Number (Bottom Right) -->
                                        <div style="text-align: right; margin-top: 4px;">
                                            <div style="display: inline-block; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; font-weight: bold; font-size: 10px; padding: 3px 8px; border-radius: 6px; border: 1px solid #fca5a5; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                                ถุงที่ 1 / ${document.getElementById('totalBags').value}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'compact':
                        stickerClass = 'qr-sticker-compact';
                        stickerHTML = `
                            <div class="${stickerClass} border-2 border-gray-300 bg-white rounded-lg shadow-lg">
                                <div style="display: flex; width: 100%; height: 100%;">
                                    <!-- QR Code Section (Left) -->
                                    <div style="flex-shrink: 0; width: 0.9in; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 0.1in;">
                                        <img src="${url}" style="width: 0.7in; height: 0.7in; border: 1px solid #ddd; border-radius: 3px;" />
                                        <div style="font-size: 7px; font-weight: bold; text-align: center; margin-top: 3px; color: #333; background: #f0f0f0; padding: 1px 4px; border-radius: 2px;">${item.jobNo}</div>
                                    </div>
                                    
                                    <!-- Content Section (Right) -->
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; font-size: 8px; line-height: 1.2;">
                                        <div>
                                            <div style="font-weight: bold; font-size: 9px; margin-bottom: 3px; color: #1a365d; border-bottom: 1px solid #e2e8f0; padding-bottom: 1px;">${item.productName}</div>
                                            
                                            <div style="color: #555; margin-bottom: 1px;"><strong>ลูกค้า:</strong> ${item.customerName || '-'}</div>
                                            <div style="color: #555; margin-bottom: 1px;"><strong>ขนาด:</strong> ${item.size || '-'}</div>
                                            <div style="color: #555; margin-bottom: 1px;"><strong>บรรจุ/ถุง:</strong> ${item.packPerBag || 0} ชิ้น</div>
                                            <div style="color: #555; font-size: 7px;"><strong>MC:</strong> ${item.mc || '-'} <strong>OE:</strong> ${item.oe || '-'}</div>
                                        </div>
                                        
                                        <!-- Bag Number (Bottom Right) -->
                                        <div style="text-align: right; margin-top: 2px;">
                                            <div style="display: inline-block; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; font-weight: bold; font-size: 8px; padding: 2px 6px; border-radius: 4px; border: 1px solid #fca5a5;">
                                                ถุงที่ 1 / ${document.getElementById('totalBags').value}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'minimal':
                        stickerClass = 'qr-sticker-minimal';
                        stickerHTML = `
                            <div class="${stickerClass} border-2 border-gray-300 bg-white rounded-lg shadow-lg">
                                <div style="text-align: center;">
                                    <img src="${url}" style="width: 0.6in; height: 0.6in; margin: 0 auto;" />
                                    <div style="font-size: 8px; font-weight: bold; margin-top: 2px; color: #333;">${item.jobNo}</div>
                                    <div style="font-size: 7px; color: #666;">ถุงที่ 1</div>
                                </div>
                            </div>
                        `;
                        break;
                }

                container.innerHTML = `
                    <div class="flex items-center justify-center">
                        ${stickerHTML}
                    </div>
                    <div class="mt-4 text-center text-sm text-gray-600">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="font-semibold text-blue-800">ขนาดจริงเมื่อพิมพ์:</div>
                            <div class="text-blue-700">
                                ${layout === 'standard' ? '4×2 นิ้ว (10.2×5.1 ซม.)' : 
                                  layout === 'compact' ? '3×1.5 นิ้ว (7.6×3.8 ซม.)' : 
                                  '2×1 นิ้ว (5.1×2.5 ซม.)'}
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function changePreviewLayout(layout) {
            selectedStickerLayout = layout;
            selectStickerLayout(layout);
            
            const jobNo = document.getElementById('qrJobSelect').value;
            const item = items.find(i => i.jobNo === jobNo);
            
            if (item) {
                document.getElementById('previewLayoutName').textContent = getStickerLayoutName(layout);
                generateStickerPreview(item, layout);
            }
        }

        function closeStickerPreview() {
            document.getElementById('stickerPreviewModal').classList.add('hidden');
        }

        function confirmAndGenerate() {
            closeStickerPreview();
            generateStickers();
        }

        function generateStickers() {
            const jobNo = document.getElementById('qrJobSelect').value;
            const totalBags = parseInt(document.getElementById('totalBags').value);
            const item = items.find(i => i.jobNo === jobNo);

            if (!item) {
                NotificationSystem.warning('กรุณาเลือก Job No.');
                return;
            }

            if (isNaN(totalBags) || totalBags <= 0) {
                NotificationSystem.warning('กรุณากรอกจำนวนถุงที่ถูกต้อง');
                return;
            }

            if (totalBags > 1000) {
                NotificationSystem.warning('จำนวนถุงไม่ควรเกิน 1,000 ถุง');
                return;
            }

            NotificationSystem.loading(`กำลังสร้างสติกเกอร์ ${totalBags} ใบ...`);

            const container = document.getElementById('stickersGrid');
            container.innerHTML = '';
            let completedStickers = 0;

            // Show progress for large batches
            if (totalBags > 10) {
                NotificationSystem.progress('กำลังสร้างสติกเกอร์...', 0);
            }

            for (let i = 1; i <= totalBags; i++) {
                const qrData = `${item.jobNo}`;

                QRCode.toDataURL(qrData, { width: selectedStickerLayout === 'minimal' ? 60 : 80 }, function (err, url) {
                    const stickerDiv = document.createElement('div');
                    
                    // Use proper CSS classes based on layout
                    let stickerClass = '';
                    switch (selectedStickerLayout) {
                        case 'standard':
                            stickerClass = 'qr-sticker';
                            break;
                        case 'compact':
                            stickerClass = 'qr-sticker-compact';
                            break;
                        case 'minimal':
                            stickerClass = 'qr-sticker-minimal';
                            break;
                        default:
                            stickerClass = 'qr-sticker';
                    }
                    
                    stickerDiv.className = `${stickerClass} shadow-md relative cursor-pointer hover:shadow-lg transition-shadow`;
                    stickerDiv.setAttribute('data-page', i);
                    
                    // Add click event for selection
                    stickerDiv.onclick = () => toggleStickerSelection(stickerDiv);

                    // Generate sticker content based on layout
                    let stickerContent = '';
                    
                    switch (selectedStickerLayout) {
                        case 'standard':
                            stickerContent = `
                                <div style="display: flex; width: 100%; height: 100%;">
                                    <!-- QR Code Section (Left) -->
                                    <div style="flex-shrink: 0; width: 1.2in; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 0.15in;">
                                        <img src="${url}" style="width: 0.9in; height: 0.9in; border: 1px solid #ddd; border-radius: 4px;" />
                                        <div style="font-size: 8px; font-weight: bold; text-align: center; margin-top: 4px; color: #333; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${item.jobNo}</div>
                                        <div style="font-size: 7px; text-align: center; margin-top: 2px; color: #666;">MC: ${item.mc || '-'}</div>
                                    </div>
                                    
                                    <!-- Content Section (Right) -->
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; font-size: 9px; line-height: 1.3;">
                                        <div>
                                            <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px; color: #1a365d; border-bottom: 1px solid #e2e8f0; padding-bottom: 2px;">${item.productName}</div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin-bottom: 3px;">
                                                <div style="color: #555; font-size: 8px;"><strong>วันที่:</strong> ${item.date || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>กำหนดส่ง:</strong> ${item.dueDate || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>รหัส:</strong> ${item.productCode || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>OE:</strong> ${item.oe || '-'}</div>
                                            </div>
                                            
                                            <div style="margin-bottom: 3px;">
                                                <div style="color: #555; font-size: 8px; margin-bottom: 1px;"><strong>ขนาด:</strong> ${item.size || '-'} <strong>สี:</strong> ${item.color || '-'}</div>
                                                <div style="color: #555; font-size: 8px; margin-bottom: 1px;"><strong>ลูกค้า:</strong> ${item.customerName || '-'}</div>
                                                <div style="color: #555; font-size: 8px;"><strong>บรรจุ/ถุง:</strong> ${item.packPerBag || 0} ชิ้น</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Bag Number (Bottom Right) -->
                                        <div style="text-align: right; margin-top: 4px;">
                                            <div style="display: inline-block; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; font-weight: bold; font-size: 10px; padding: 3px 8px; border-radius: 6px; border: 1px solid #fca5a5; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                                ถุงที่ ${i} / ${totalBags}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            break;
                        
                        case 'compact':
                            stickerContent = `
                                <div style="display: flex; width: 100%; height: 100%;">
                                    <!-- QR Code Section (Left) -->
                                    <div style="flex-shrink: 0; width: 0.9in; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 0.1in;">
                                        <img src="${url}" style="width: 0.7in; height: 0.7in; border: 1px solid #ddd; border-radius: 3px;" />
                                        <div style="font-size: 7px; font-weight: bold; text-align: center; margin-top: 3px; color: #333; background: #f0f0f0; padding: 1px 4px; border-radius: 2px;">${item.jobNo}</div>
                                    </div>
                                    
                                    <!-- Content Section (Right) -->
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: space-between; font-size: 8px; line-height: 1.2;">
                                        <div>
                                            <div style="font-weight: bold; font-size: 9px; margin-bottom: 3px; color: #1a365d; border-bottom: 1px solid #e2e8f0; padding-bottom: 1px;">${item.productName}</div>
                                            
                                            <div style="color: #555; margin-bottom: 1px;"><strong>ลูกค้า:</strong> ${item.customerName || '-'}</div>
                                            <div style="color: #555; margin-bottom: 1px;"><strong>ขนาด:</strong> ${item.size || '-'}</div>
                                            <div style="color: #555; margin-bottom: 1px;"><strong>บรรจุ/ถุง:</strong> ${item.packPerBag || 0} ชิ้น</div>
                                            <div style="color: #555; font-size: 7px;"><strong>MC:</strong> ${item.mc || '-'} <strong>OE:</strong> ${item.oe || '-'}</div>
                                        </div>
                                        
                                        <!-- Bag Number (Bottom Right) -->
                                        <div style="text-align: right; margin-top: 2px;">
                                            <div style="display: inline-block; background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; font-weight: bold; font-size: 8px; padding: 2px 6px; border-radius: 4px; border: 1px solid #fca5a5;">
                                                ถุงที่ ${i} / ${totalBags}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            break;
                        
                        case 'minimal':
                            stickerContent = `
                                <div style="text-align: center;">
                                    <img src="${url}" style="width: 0.6in; height: 0.6in; margin: 0 auto;" />
                                    <div style="font-size: 8px; font-weight: bold; margin-top: 2px; color: #333;">${item.jobNo}</div>
                                    <div style="font-size: 7px; color: #666;">ถุงที่ ${i}</div>
                                </div>
                            `;
                            break;
                    }

                    stickerDiv.innerHTML = stickerContent;
                    container.appendChild(stickerDiv);
                    completedStickers++;

                    // Update progress
                    const progress = Math.round((completedStickers / totalBags) * 100);
                    if (totalBags > 10) {
                        NotificationSystem.progress('กำลังสร้างสติกเกอร์...', progress);
                    }

                    // Complete when all stickers are generated
                    if (completedStickers === totalBags) {
                        setTimeout(() => {
                            NotificationSystem.closeLoading();
                            NotificationSystem.success(`สร้างสติกเกอร์ ${totalBags} ใบเรียบร้อย (รูปแบบ: ${getStickerLayoutName(selectedStickerLayout)})`);
                            document.getElementById('stickersContainer').classList.remove('hidden');
                            
                            // Update grid layout based on sticker type
                            const stickersGrid = document.getElementById('stickersGrid');
                            switch (selectedStickerLayout) {
                                case 'standard':
                                    stickersGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 layout-standard';
                                    break;
                                case 'compact':
                                    stickersGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 layout-compact';
                                    break;
                                case 'minimal':
                                    stickersGrid.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 layout-minimal';
                                    break;
                                default:
                                    stickersGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 layout-standard';
                            }
                            
                            // Initialize sticker controls
                            updateSelectedStickersCount();
                            
                            // Select all stickers by default
                            selectAllStickers();
                        }, 500);
                    }
                });
            }
        }

        function printStickers() {
            const printMode = document.getElementById('printMode').value;
            const stickersContainer = document.getElementById('stickersContainer');
            
            if (printMode === 'pdf') {
                downloadStickersAsPDF();
                return;
            }
            
            // Store original classes
            const originalContainerClass = stickersContainer.className;
            const stickersGrid = document.getElementById('stickersGrid');
            const originalGridClass = stickersGrid.className;
            
            try {
                // Apply print mode class
                stickersContainer.className = `mt-6 print-mode-${printMode}`;
                
                // Adjust grid layout for print
                if (printMode === 'multi') {
                    // Calculate how many stickers fit per row based on layout
                    const stickers = stickersGrid.querySelectorAll('[class*="qr-sticker"]');
                    if (stickers.length > 0) {
                        const firstSticker = stickers[0];
                        if (firstSticker.classList.contains('qr-sticker-minimal')) {
                            stickersGrid.className = 'grid grid-cols-4 gap-1'; // 4 minimal per row
                        } else if (firstSticker.classList.contains('qr-sticker-compact')) {
                            stickersGrid.className = 'grid grid-cols-2 gap-1'; // 2 compact per row
                        } else {
                            stickersGrid.className = 'grid grid-cols-2 gap-1'; // 2 standard per row
                        }
                    } else {
                        stickersGrid.className = 'grid grid-cols-2 gap-1'; // fallback
                    }
                } else {
                    stickersGrid.className = 'grid grid-cols-1 gap-4'; // one per page
                }
                
                // Hide page controls and checkboxes for printing
                const pageControls = document.getElementById('pageControls');
                const originalPageControlsDisplay = pageControls ? pageControls.style.display : '';
                if (pageControls) pageControls.style.display = 'none';
                
                const checkboxes = document.querySelectorAll('.page-checkbox');
                checkboxes.forEach(cb => cb.style.display = 'none');
                
                // Add print-specific styles
                const printStyleSheet = document.createElement('style');
                printStyleSheet.id = 'print-temp-styles';
                printStyleSheet.textContent = `
                    @media print {
                        .qr-sticker, .qr-sticker-compact, .qr-sticker-minimal {
                            break-inside: avoid;
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        .print-mode-multi .qr-sticker:nth-child(2n) {
                            break-after: avoid;
                        }
                        
                        .print-mode-multi .qr-sticker-minimal:nth-child(4n) {
                            break-after: auto;
                        }
                    }
                `;
                document.head.appendChild(printStyleSheet);
                
                // Show loading message
                NotificationSystem.info('กำลังเตรียมการพิมพ์... กรุณารอสักครู่');
                
                // Delay to ensure styles are applied
                setTimeout(() => {
                    // Print
                    window.print();
                    
                    // Cleanup after printing
                    setTimeout(() => {
                        // Restore original classes
                        stickersContainer.className = originalContainerClass;
                        stickersGrid.className = originalGridClass;
                        
                        // Restore page controls
                        if (pageControls) pageControls.style.display = originalPageControlsDisplay;
                        
                        // Restore checkboxes
                        checkboxes.forEach(cb => cb.style.display = '');
                        
                        // Remove temporary print styles
                        const tempStyles = document.getElementById('print-temp-styles');
                        if (tempStyles) tempStyles.remove();
                        
                        NotificationSystem.success('พิมพ์เสร็จสิ้น');
                    }, 1000);
                }, 500);
                
            } catch (error) {
                console.error('Print error:', error);
                
                // Restore original state on error
                stickersContainer.className = originalContainerClass;
                stickersGrid.className = originalGridClass;
                
                NotificationSystem.error('เกิดข้อผิดพลาดในการพิมพ์');
            }
        }

        function downloadStickersAsPDF() {
            const element = document.getElementById("stickersContainer");
            const printButton = element.querySelector('button');
            const selectElement = element.querySelector('select');
            
            // Hide print controls temporarily
            if (printButton) printButton.style.display = 'none';
            if (selectElement) selectElement.parentElement.style.display = 'none';
            
            // Configure PDF options
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `stickers_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };
            
            // Generate PDF
            html2pdf().set(opt).from(element).save().then(() => {
                // Restore print controls
                if (printButton) printButton.style.display = '';
                if (selectElement) selectElement.parentElement.style.display = '';
            });
        }

        function previewPrint() {
            const printMode = document.getElementById('printMode').value;
            const stickersContainer = document.getElementById('stickersContainer');
            const stickersGrid = document.getElementById('stickersGrid');
            
            // Store original classes
            const originalContainerClass = stickersContainer.className;
            const originalGridClass = stickersGrid.className;
            
            // Apply print mode styling for preview
            stickersContainer.className = `mt-6 print-mode-${printMode}`;
            
            if (printMode === 'multi') {
                stickersGrid.className = 'grid grid-cols-2 gap-2';
            } else {
                stickersGrid.className = 'grid grid-cols-1 gap-4';
            }
            
            // Show preview message
            const previewMsg = document.createElement('div');
            previewMsg.id = 'previewMessage';
            previewMsg.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            previewMsg.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="fas fa-eye"></i>
                    <span>ตัวอย่างการพิมพ์แบบ: ${printMode === 'one' ? '1 ใบ/หน้า' : printMode === 'multi' ? 'หลายใบ/หน้า' : 'PDF'}</span>
                    <button onclick="exitPreview()" class="bg-white text-blue-600 px-3 py-1 rounded text-sm hover:bg-gray-100">
                        ออกจากตัวอย่าง
                    </button>
                </div>
            `;
            document.body.appendChild(previewMsg);
            
            // Store original classes for restoration
            window.previewOriginalClasses = {
                container: originalContainerClass,
                grid: originalGridClass
            };
        }

        function exitPreview() {
            const stickersContainer = document.getElementById('stickersContainer');
            const stickersGrid = document.getElementById('stickersGrid');
            const previewMsg = document.getElementById('previewMessage');
            
            // Restore original classes
            if (window.previewOriginalClasses) {
                stickersContainer.className = window.previewOriginalClasses.container;
                stickersGrid.className = window.previewOriginalClasses.grid;
            }
            
            // Remove preview message
            if (previewMsg) {
                previewMsg.remove();
            }
        }

        // Sticker Selection Functions
        function updateSelectedStickersCount() {
            const stickers = document.querySelectorAll('.qr-sticker, .qr-sticker-compact, .qr-sticker-minimal');
            const selectedStickers = document.querySelectorAll('.qr-sticker.selected, .qr-sticker-compact.selected, .qr-sticker-minimal.selected');
            
            const selectedCountElement = document.getElementById('selectedStickersCount');
            const totalCountElement = document.getElementById('totalStickersCount');
            
            if (selectedCountElement) selectedCountElement.textContent = selectedStickers.length;
            if (totalCountElement) totalCountElement.textContent = stickers.length;
        }

        function selectAllStickers() {
            const stickers = document.querySelectorAll('.qr-sticker, .qr-sticker-compact, .qr-sticker-minimal');
            stickers.forEach(sticker => {
                sticker.classList.add('selected');
            });
            updateSelectedStickersCount();
            NotificationSystem.success('เลือกสติกเกอร์ทั้งหมดแล้ว');
        }

        function deselectAllStickers() {
            const stickers = document.querySelectorAll('.qr-sticker, .qr-sticker-compact, .qr-sticker-minimal');
            stickers.forEach(sticker => {
                sticker.classList.remove('selected');
            });
            updateSelectedStickersCount();
            NotificationSystem.info('ยกเลิกการเลือกสติกเกอร์ทั้งหมดแล้ว');
        }

        function toggleStickerSelection(sticker) {
            sticker.classList.toggle('selected');
            updateSelectedStickersCount();
        }

        // Receive Functions
        function handleReceiveJobNoInput(event) {
            // Handle autocomplete
            autocompleteJobNo('receiveJobNo');
        }

        function handleReceiveJobNoKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadReceiveData();
            }
        }

        function loadReceiveData() {
            const jobNo = document.getElementById('receiveJobNo').value.trim();
            
            if (!jobNo) {
                NotificationSystem.warning('กรุณากรอก Job No.');
                return;
            }

            const item = items.find(item => item.jobNo && item.jobNo.toLowerCase() === jobNo.toLowerCase());
            
            if (item) {
                document.getElementById('receiveMC').value = item.mc || '';
                document.getElementById('receiveOE').value = item.oe || '';
                document.getElementById('receiveProductCode').value = item.productCode || '';
                document.getElementById('receiveProductName').value = item.productName || '';
                document.getElementById('receiveSize').value = item.size || '';
                document.getElementById('receiveColor').value = item.color || '';
                document.getElementById('receiveCustomerName').value = item.customerName || '';
                document.getElementById('receiveCapCode').value = item.capCode || '';
                document.getElementById('receivePackPerBag').value = item.packPerBag || '';
                
                // Hide autocomplete results
                document.getElementById('receiveJobNoResults').classList.add('hidden');
                
                NotificationSystem.success(`โหลดข้อมูล ${item.productName} เรียบร้อย`);
            } else {
                NotificationSystem.error(`ไม่พบข้อมูล Job No. "${jobNo}"`);
                // Clear form when not found
                clearReceiveFormData();
            }
        }

        function clearReceiveFormData() {
            document.getElementById('receiveMC').value = '';
            document.getElementById('receiveOE').value = '';
            document.getElementById('receiveProductCode').value = '';
            document.getElementById('receiveProductName').value = '';
            document.getElementById('receiveSize').value = '';
            document.getElementById('receiveColor').value = '';
            document.getElementById('receiveCustomerName').value = '';
            document.getElementById('receiveCapCode').value = '';
            document.getElementById('receivePackPerBag').value = '';
        }

        function calculateReceiveTotal() {
            const bagQty = parseInt(document.getElementById('receiveBagQty').value) || 0;
            const packPerBag = parseInt(document.getElementById('receivePackPerBag').value) || 0;
            document.getElementById('receiveTotal').value = bagQty * packPerBag;
        }

        async function saveReceive() {
            const receive = {
                date: document.getElementById('receiveDate').value,
                jobNo: document.getElementById('receiveJobNo').value,
                mc: document.getElementById('receiveMC').value,
                oe: document.getElementById('receiveOE').value,
                productCode: document.getElementById('receiveProductCode').value,
                productName: document.getElementById('receiveProductName').value,
                size: document.getElementById('receiveSize').value,
                color: document.getElementById('receiveColor').value,
                customerName: document.getElementById('receiveCustomerName').value,
                capCode: document.getElementById('receiveCapCode').value,
                packPerBag: parseInt(document.getElementById('receivePackPerBag').value) || 0,
                bagQty: parseInt(document.getElementById('receiveBagQty').value) || 0,
                total: parseInt(document.getElementById('receiveTotal').value) || 0,
                waste: parseInt(document.getElementById('receiveWaste').value) || 0,
                type: 'receive',
                user: currentUser ? currentUser.fullName : 'system',
                userEmail: currentUser ? currentUser.email : 'system',
                timestamp: new Date().toISOString()
            };

            if (!receive.jobNo || !receive.bagQty) {
                NotificationSystem.warning('กรุณากรอก Job No. และจำนวนถุง');
                return;
            }

            if (receive.bagQty <= 0) {
                NotificationSystem.warning('จำนวนถุงต้องมากกว่า 0');
                return;
            }

            NotificationSystem.loading('กำลังบันทึกรับเข้า...');

            try {
                await saveReceiveToFirebase(receive);
                
                // Log audit action
                await logAuditAction('receive', 'inventory', receive.id, receive.productName, 
                    `รับเข้าสินค้า Job No: ${receive.jobNo} จำนวน ${receive.total.toLocaleString()} ชิ้น`, null, receive);
                
                loadReceiveHistory();
                clearReceiveForm();
                updateDashboard();
                NotificationSystem.closeLoading();
                NotificationSystem.success(`บันทึกรับเข้า ${receive.productName} จำนวน ${receive.total.toLocaleString()} ชิ้น เรียบร้อย`);
            } catch (error) {
                NotificationSystem.closeLoading();
                NotificationSystem.error('เกิดข้อผิดพลาดในการบันทึกรับเข้า');
            }
        }

        function clearReceiveForm() {
            document.getElementById('receiveJobNo').value = '';
            document.getElementById('receiveMC').value = '';
            document.getElementById('receiveOE').value = '';
            document.getElementById('receiveProductCode').value = '';
            document.getElementById('receiveProductName').value = '';
            document.getElementById('receiveSize').value = '';
            document.getElementById('receiveColor').value = '';
            document.getElementById('receiveCustomerName').value = '';
            document.getElementById('receiveCapCode').value = '';
            document.getElementById('receivePackPerBag').value = '';
            document.getElementById('receiveBagQty').value = '';
            document.getElementById('receiveTotal').value = '';
            document.getElementById('receiveWaste').value = '';
        }

        function loadReceiveHistory() {
            const container = document.getElementById('receiveHistory');
            container.innerHTML = '';
            
            receiveHistory.slice(-5).reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded border text-sm';
                div.innerHTML = `
                    <div class="font-semibold">${item.jobNo} - ${item.productName}</div>
                    <div class="text-gray-600">${item.date} | จำนวน: ${item.total} | โดย: ${item.user}</div>
                `;
                container.appendChild(div);
            });
        }

        // Issue Functions
        function handleIssueJobNoInput(event) {
            // Handle autocomplete
            autocompleteJobNo('issueJobNo');
        }

        function handleIssueJobNoKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadIssueData();
            }
        }

        function loadIssueData() {
            const jobNo = document.getElementById('issueJobNo').value.trim();
            
            if (!jobNo) {
                NotificationSystem.warning('กรุณากรอก Job No.');
                return;
            }

            const item = items.find(item => item.jobNo && item.jobNo.toLowerCase() === jobNo.toLowerCase());
            
            if (item) {
                document.getElementById('issueMC').value = item.mc || '';
                document.getElementById('issueOE').value = item.oe || '';
                document.getElementById('issueProductCode').value = item.productCode || '';
                document.getElementById('issueProductName').value = item.productName || '';
                document.getElementById('issueSize').value = item.size || '';
                document.getElementById('issueColor').value = item.color || '';
                document.getElementById('issueCustomerName').value = item.customerName || '';
                document.getElementById('issueCapCode').value = item.capCode || '';
                document.getElementById('issuePackPerBag').value = item.packPerBag || '';
                
                // Hide autocomplete results
                document.getElementById('issueJobNoResults').classList.add('hidden');
                
                NotificationSystem.success(`โหลดข้อมูล ${item.productName} เรียบร้อย`);
            } else {
                NotificationSystem.error(`ไม่พบข้อมูล Job No. "${jobNo}"`);
                // Clear form when not found
                clearIssueFormData();
            }
        }

        function clearIssueFormData() {
            document.getElementById('issueMC').value = '';
            document.getElementById('issueOE').value = '';
            document.getElementById('issueProductCode').value = '';
            document.getElementById('issueProductName').value = '';
            document.getElementById('issueSize').value = '';
            document.getElementById('issueColor').value = '';
            document.getElementById('issueCustomerName').value = '';
            document.getElementById('issueCapCode').value = '';
            document.getElementById('issuePackPerBag').value = '';
        }

        function calculateIssueTotal() {
            const bagQty = parseInt(document.getElementById('issueBagQty').value) || 0;
            const packPerBag = parseInt(document.getElementById('issuePackPerBag').value) || 0;
            document.getElementById('issueTotal').value = bagQty * packPerBag;
        }

        async function saveIssue() {
            const issue = {
                date: document.getElementById('issueDate').value,
                jobNo: document.getElementById('issueJobNo').value,
                mc: document.getElementById('issueMC').value,
                oe: document.getElementById('issueOE').value,
                productCode: document.getElementById('issueProductCode').value,
                productName: document.getElementById('issueProductName').value,
                size: document.getElementById('issueSize').value,
                color: document.getElementById('issueColor').value,
                customerName: document.getElementById('issueCustomerName').value,
                capCode: document.getElementById('issueCapCode').value,
                packPerBag: parseInt(document.getElementById('issuePackPerBag').value) || 0,
                bagQty: parseInt(document.getElementById('issueBagQty').value) || 0,
                total: parseInt(document.getElementById('issueTotal').value) || 0,
                waste: parseInt(document.getElementById('issueWaste').value) || 0,
                type: 'issue',
                user: currentUser ? currentUser.fullName : 'system',
                userEmail: currentUser ? currentUser.email : 'system',
                timestamp: new Date().toISOString()
            };

            if (!issue.jobNo || !issue.bagQty) {
                NotificationSystem.warning('กรุณากรอก Job No. และจำนวนถุง');
                return;
            }

            if (issue.bagQty <= 0) {
                NotificationSystem.warning('จำนวนถุงต้องมากกว่า 0');
                return;
            }

            // Check stock availability
            const inventory = calculateInventory();
            const currentStock = inventory.find(item => item.jobNo === issue.jobNo);
            
            if (currentStock && currentStock.balance < issue.total) {
                const confirmed = await NotificationSystem.confirm(
                    `สต็อกคงเหลือ ${currentStock.balance.toLocaleString()} ชิ้น น้อยกว่าที่ต้องการจ่าย ${issue.total.toLocaleString()} ชิ้น\nต้องการดำเนินการต่อหรือไม่?`,
                    'สต็อกไม่เพียงพอ'
                );
                
                if (!confirmed) return;
            }

            NotificationSystem.loading('กำลังบันทึกจ่ายออก...');

            try {
                await saveIssueToFirebase(issue);
                
                // Log audit action
                await logAuditAction('issue', 'inventory', issue.id, issue.productName, 
                    `จ่ายออกสินค้า Job No: ${issue.jobNo} จำนวน ${issue.total.toLocaleString()} ชิ้น`, null, issue);
                
                loadIssueHistory();
                clearIssueForm();
                updateDashboard();
                NotificationSystem.closeLoading();
                NotificationSystem.success(`บันทึกจ่ายออก ${issue.productName} จำนวน ${issue.total.toLocaleString()} ชิ้น เรียบร้อย`);
            } catch (error) {
                NotificationSystem.closeLoading();
                NotificationSystem.error('เกิดข้อผิดพลาดในการบันทึกจ่ายออก');
            }
        }

        function clearIssueForm() {
            document.getElementById('issueJobNo').value = '';
            document.getElementById('issueMC').value = '';
            document.getElementById('issueOE').value = '';
            document.getElementById('issueProductCode').value = '';
            document.getElementById('issueProductName').value = '';
            document.getElementById('issueSize').value = '';
            document.getElementById('issueColor').value = '';
            document.getElementById('issueCustomerName').value = '';
            document.getElementById('issueCapCode').value = '';
            document.getElementById('issuePackPerBag').value = '';
            document.getElementById('issueBagQty').value = '';
            document.getElementById('issueTotal').value = '';
            document.getElementById('issueWaste').value = '';
        }

        function loadIssueHistory() {
            const container = document.getElementById('issueHistory');
            container.innerHTML = '';
            
            issueHistory.slice(-5).reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded border text-sm';
                div.innerHTML = `
                    <div class="font-semibold">${item.jobNo} - ${item.productName}</div>
                    <div class="text-gray-600">${item.date} | จำนวน: ${item.total} | โดย: ${item.user}</div>
                `;
                container.appendChild(div);
            });
        }

        // History Functions
        function loadHistory() {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            const allHistory = [...receiveHistory, ...issueHistory].sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            allHistory.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${item.date}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${item.type === 'receive' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                            ${item.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium">${item.jobNo}</td>
                    <td class="px-4 py-3 text-sm">${item.productName}</td>
                    <td class="px-4 py-3 text-sm">${item.customerName}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${item.total.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.user || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="deleteHistory('${item.type}', ${item.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteHistory(type, id) {
            const confirmed = await NotificationSystem.confirmDelete('ประวัตินี้');
            
            if (confirmed) {
                if (type === 'receive') {
                    receiveHistory = receiveHistory.filter(item => item.id !== id);
                    localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
                } else {
                    issueHistory = issueHistory.filter(item => item.id !== id);
                    localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
                }
                loadHistory();
                updateDashboard();
                NotificationSystem.success('ลบประวัติเรียบร้อย');
            }
        }

        function searchHistory() {
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
            const historyType = document.getElementById('historyType').value;
            const dateFrom = document.getElementById('historyDateFrom').value;
            const dateTo = document.getElementById('historyDateTo').value;
            
            let allHistory = [...receiveHistory, ...issueHistory];
            
            // Filter by type
            if (historyType !== 'all') {
                allHistory = allHistory.filter(item => item.type === historyType);
            }
            
            // Filter by search term
            if (searchTerm) {
                allHistory = allHistory.filter(item => 
                    (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                    (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                    (item.customerName && item.customerName.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filter by date range
            if (dateFrom) {
                allHistory = allHistory.filter(item => item.date >= dateFrom);
            }
            if (dateTo) {
                allHistory = allHistory.filter(item => item.date <= dateTo);
            }
            
            // Update table
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            allHistory.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date)).forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${item.date}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${item.type === 'receive' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">
                            ${item.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium">${item.jobNo}</td>
                    <td class="px-4 py-3 text-sm">${item.productName}</td>
                    <td class="px-4 py-3 text-sm">${item.customerName}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${item.total.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${item.user || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="deleteHistory('${item.type}', ${item.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Inventory Functions
        function calculateInventory() {
            const inventory = {};
            
            // Initialize inventory from items
            items.forEach(item => {
                const key = `${item.jobNo}_${item.productCode}_${item.oe}`;
                inventory[key] = {
                    ...item,
                    received: 0,
                    issued: 0,
                    balance: 0
                };
            });
            
            // Add received quantities
            receiveHistory.forEach(receive => {
                const key = `${receive.jobNo}_${receive.productCode}_${receive.oe}`;
                if (inventory[key]) {
                    inventory[key].received += receive.total || 0;
                }
            });
            
            // Subtract issued quantities
            issueHistory.forEach(issue => {
                const key = `${issue.jobNo}_${issue.productCode}_${issue.oe}`;
                if (inventory[key]) {
                    inventory[key].issued += issue.total || 0;
                }
            });
            
            // Calculate balance
            Object.keys(inventory).forEach(key => {
                inventory[key].balance = inventory[key].received - inventory[key].issued;
            });
            
            return Object.values(inventory);
        }

        function loadInventory() {
            const inventoryData = calculateInventory();
            const groupBy = document.getElementById('inventoryGroupBy').value;
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            // Update summary cards
            updateInventorySummary(inventoryData);
            
            // Group data if needed
            let displayData = inventoryData;
            if (groupBy !== 'jobNo') {
                const grouped = {};
                inventoryData.forEach(item => {
                    const groupKey = item[groupBy] || 'ไม่ระบุ';
                    if (!grouped[groupKey]) {
                        grouped[groupKey] = {
                            ...item,
                            received: 0,
                            issued: 0,
                            balance: 0,
                            count: 0
                        };
                    }
                    grouped[groupKey].received += item.received;
                    grouped[groupKey].issued += item.issued;
                    grouped[groupKey].balance += item.balance;
                    grouped[groupKey].count += 1;
                });
                displayData = Object.values(grouped);
            }
            
            displayData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const balanceClass = item.balance > 0 ? 'text-green-600' : item.balance < 0 ? 'text-red-600' : 'text-gray-600';
                const statusClass = item.balance > 0 ? 'bg-green-100 text-green-800' : item.balance < 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                const statusText = item.balance > 0 ? 'มีสต็อก' : item.balance < 0 ? 'ขาดสต็อก' : 'หมดสต็อก';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium">${item.productCode || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.productName || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.jobNo || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.oe || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.customerName || '-'}</td>
                    <td class="px-4 py-3 text-sm text-green-600 font-semibold">${item.received.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-red-600 font-semibold">${item.issued.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm ${balanceClass} font-semibold">${item.balance.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewItemDetails('${item.jobNo}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateInventorySummary(inventoryData) {
            const totalItems = inventoryData.length;
            const totalReceived = inventoryData.reduce((sum, item) => sum + item.received, 0);
            const totalIssued = inventoryData.reduce((sum, item) => sum + item.issued, 0);
            const totalBalance = inventoryData.reduce((sum, item) => sum + item.balance, 0);
            
            document.getElementById('totalItems').textContent = totalItems.toLocaleString();
            document.getElementById('totalReceived').textContent = totalReceived.toLocaleString();
            document.getElementById('totalIssued').textContent = totalIssued.toLocaleString();
            document.getElementById('totalBalance').textContent = totalBalance.toLocaleString();
        }

        function searchInventory() {
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const inventoryData = calculateInventory();
            
            let filteredData = inventoryData;
            if (searchTerm) {
                filteredData = inventoryData.filter(item => 
                    (item.productCode && item.productCode.toLowerCase().includes(searchTerm)) ||
                    (item.jobNo && item.jobNo.toLowerCase().includes(searchTerm)) ||
                    (item.oe && item.oe.toLowerCase().includes(searchTerm)) ||
                    (item.productName && item.productName.toLowerCase().includes(searchTerm)) ||
                    (item.customerName && item.customerName.toLowerCase().includes(searchTerm))
                );
            }
            
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const balanceClass = item.balance > 0 ? 'text-green-600' : item.balance < 0 ? 'text-red-600' : 'text-gray-600';
                const statusClass = item.balance > 0 ? 'bg-green-100 text-green-800' : item.balance < 0 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800';
                const statusText = item.balance > 0 ? 'มีสต็อก' : item.balance < 0 ? 'ขาดสต็อก' : 'หมดสต็อก';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium">${item.productCode || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.productName || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.jobNo || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.oe || '-'}</td>
                    <td class="px-4 py-3 text-sm">${item.customerName || '-'}</td>
                    <td class="px-4 py-3 text-sm text-green-600 font-semibold">${item.received.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-red-600 font-semibold">${item.issued.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm ${balanceClass} font-semibold">${item.balance.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewItemDetails('${item.jobNo}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateInventorySummary(filteredData);
        }

        function refreshInventory() {
            loadInventory();
        }

        function viewItemDetails(jobNo) {
            const item = items.find(i => i.jobNo === jobNo);
            if (item) {
                alert(`รายละเอียดสินค้า:\n\nJob No: ${item.jobNo}\nรหัสสินค้า: ${item.productCode}\nชื่อสินค้า: ${item.productName}\nลูกค้า: ${item.customerName}\nขนาด: ${item.size}\nสี: ${item.color}\nกำหนดส่ง: ${item.dueDate}`);
            }
        }

        // Menu Toggle Functions
        function toggleImportMenu() {
            const menu = document.getElementById('importMenu');
            menu.classList.toggle('hidden');
            // Close other menus
            document.getElementById('exportMenu').classList.add('hidden');
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
            // Close other menus
            document.getElementById('importMenu').classList.add('hidden');
        }

        function toggleInventoryExportMenu() {
            const menu = document.getElementById('inventoryExportMenu');
            menu.classList.toggle('hidden');
        }

        function toggleHistoryExportMenu() {
            const menu = document.getElementById('historyExportMenu');
            menu.classList.toggle('hidden');
        }

        // Excel Export Functions
        function exportExcel() {
            if (items.length === 0) {
                NotificationSystem.warning('ไม่มีข้อมูลสินค้าให้ Export');
                return;
            }

            NotificationSystem.loading('กำลังสร้างไฟล์ Excel...');

            setTimeout(() => {
                try {
                    // Create workbook
                    const wb = XLSX.utils.book_new();
                    
                    // Prepare data with Thai headers
                    const headers = [
                        'วันที่', 'MC', 'Job No.', 'กำหนดส่ง', 'OE', 'รหัสสินค้า', 'ชื่อสินค้า', 
                        'ขนาด', 'สี', 'รหัสลูกค้า', 'ชื่อลูกค้า', 'โลโก้', 'วัสดุประกอบ', 
                        'รหัสฝา', 'จำนวนผลิต', 'บรรจุ/ถุง', 'จำนวนถุง', 'เศษ'
                    ];
                    
                    const data = items.map(item => [
                        item.date || '', item.mc || '', item.jobNo || '', item.dueDate || '',
                        item.oe || '', item.productCode || '', item.productName || '',
                        item.size || '', item.color || '', item.customerCode || '',
                        item.customerName || '', item.logo || '', item.material || '',
                        item.capCode || '', item.productionQty || 0, item.packPerBag || 0,
                        item.bagQty || 0, item.waste || 0
                    ]);
                    
                    // Create worksheet
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    
                    // Set column widths
                    const colWidths = [
                        {wch: 12}, {wch: 8}, {wch: 15}, {wch: 12}, {wch: 10},
                        {wch: 15}, {wch: 25}, {wch: 10}, {wch: 10}, {wch: 12},
                        {wch: 20}, {wch: 10}, {wch: 15}, {wch: 12}, {wch: 12},
                        {wch: 12}, {wch: 12}, {wch: 8}
                    ];
                    ws['!cols'] = colWidths;
                    
                    // Style header row
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "4472C4" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    // Apply header styling
                    for (let i = 0; i < headers.length; i++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: i });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, "ข้อมูลสินค้า");
                    
                    // Generate filename
                    const filename = `items_${new Date().toISOString().split('T')[0]}.xlsx`;
                    
                    // Save file
                    XLSX.writeFile(wb, filename);
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.success(`Export ข้อมูลสินค้า ${items.length} รายการเป็น Excel เรียบร้อย`);
                    
                    // Close menu
                    document.getElementById('exportMenu').classList.add('hidden');
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel');
                }
            }, 1000);
        }

        function exportInventoryExcel() {
            const inventoryData = calculateInventory();
            
            if (inventoryData.length === 0) {
                NotificationSystem.warning('ไม่มีข้อมูลสินค้าคงเหลือให้ Export');
                return;
            }

            NotificationSystem.loading('กำลังสร้างไฟล์ Excel สินค้าคงเหลือ...');

            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    
                    const headers = ['รหัสสินค้า', 'ชื่อสินค้า', 'Job No.', 'OE', 'ลูกค้า', 'รับเข้า', 'จ่ายออก', 'คงเหลือ', 'สถานะ'];
                    
                    const data = inventoryData.map(item => [
                        item.productCode || '',
                        item.productName || '',
                        item.jobNo || '',
                        item.oe || '',
                        item.customerName || '',
                        item.received || 0,
                        item.issued || 0,
                        item.balance || 0,
                        item.balance > 0 ? 'มีสต็อก' : item.balance < 0 ? 'ขาดสต็อก' : 'หมดสต็อก'
                    ]);
                    
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    
                    // Set column widths
                    ws['!cols'] = [
                        {wch: 15}, {wch: 25}, {wch: 15}, {wch: 10}, {wch: 20},
                        {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}
                    ];
                    
                    // Style header
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "FF8C00" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    for (let i = 0; i < headers.length; i++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: i });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, "สินค้าคงเหลือ");
                    
                    const filename = `inventory_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.success(`Export สินค้าคงเหลือ ${inventoryData.length} รายการเป็น Excel เรียบร้อย`);
                    
                    document.getElementById('inventoryExportMenu').classList.add('hidden');
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel');
                }
            }, 1000);
        }

        function exportHistoryExcel() {
            const allHistory = [...receiveHistory, ...issueHistory].sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            if (allHistory.length === 0) {
                NotificationSystem.warning('ไม่มีประวัติการทำงานให้ Export');
                return;
            }

            NotificationSystem.loading('กำลังสร้างไฟล์ Excel ประวัติการทำงาน...');

            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    
                    const headers = ['วันที่', 'ประเภท', 'Job No.', 'สินค้า', 'ลูกค้า', 'จำนวน', 'ผู้ใช้', 'เวลา'];
                    
                    const data = allHistory.map(item => [
                        item.date || '',
                        item.type === 'receive' ? 'รับเข้า' : 'จ่ายออก',
                        item.jobNo || '',
                        item.productName || '',
                        item.customerName || '',
                        item.total || 0,
                        item.user || '',
                        item.timestamp ? new Date(item.timestamp).toLocaleString('th-TH') : ''
                    ]);
                    
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    
                    ws['!cols'] = [
                        {wch: 12}, {wch: 10}, {wch: 15}, {wch: 25}, {wch: 20},
                        {wch: 12}, {wch: 15}, {wch: 20}
                    ];
                    
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "9966CC" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    for (let i = 0; i < headers.length; i++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: i });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, "ประวัติการทำงาน");
                    
                    const filename = `history_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.success(`Export ประวัติการทำงาน ${allHistory.length} รายการเป็น Excel เรียบร้อย`);
                    
                    document.getElementById('historyExportMenu').classList.add('hidden');
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel');
                }
            }, 1000);
        }

        // CSV Export Functions (Legacy support)
        function exportCSV() {
            if (items.length === 0) {
                NotificationSystem.warning('ไม่มีข้อมูลสินค้าให้ Export');
                return;
            }

            NotificationSystem.loading('กำลังสร้างไฟล์ CSV...');

            setTimeout(() => {
                const csvContent = "data:text/csv;charset=utf-8," + 
                    "วันที่,MC,Job No.,กำหนดส่ง,OE,รหัสสินค้า,ชื่อสินค้า,ขนาด,สี,รหัสลูกค้า,ชื่อลูกค้า,โลโก้,วัสดุประกอบ,รหัสฝา,จำนวนผลิต,บรรจุ/ถุง,จำนวนถุง,เศษ\n" +
                    items.map(item => 
                        `${item.date},${item.mc},${item.jobNo},${item.dueDate},${item.oe},${item.productCode},${item.productName},${item.size},${item.color},${item.customerCode},${item.customerName},${item.logo},${item.material},${item.capCode},${item.productionQty},${item.packPerBag},${item.bagQty},${item.waste}`
                    ).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `items_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                NotificationSystem.closeLoading();
                NotificationSystem.success(`Export ข้อมูลสินค้า ${items.length} รายการเป็น CSV เรียบร้อย`);
                
                document.getElementById('exportMenu').classList.add('hidden');
            }, 1000);
        }

        function exportInventoryCSV() {
            const inventoryData = calculateInventory();
            const csvContent = "data:text/csv;charset=utf-8," + 
                "รหัสสินค้า,ชื่อสินค้า,Job No.,OE,ลูกค้า,รับเข้า,จ่ายออก,คงเหลือ\n" +
                inventoryData.map(item => 
                    `${item.productCode},${item.productName},${item.jobNo},${item.oe},${item.customerName},${item.received},${item.issued},${item.balance}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `inventory_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('inventoryExportMenu').classList.add('hidden');
        }

        function exportHistoryCSV() {
            const allHistory = [...receiveHistory, ...issueHistory];
            const csvContent = "data:text/csv;charset=utf-8," + 
                "วันที่,ประเภท,Job No.,สินค้า,ลูกค้า,จำนวน,ผู้ใช้\n" +
                allHistory.map(item => 
                    `${item.date},${item.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'},${item.jobNo},${item.productName},${item.customerName},${item.total},${item.user}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `history_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('historyExportMenu').classList.add('hidden');
        }

        // Excel Import Functions
        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    NotificationSystem.loading('กำลังอ่านไฟล์ Excel...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // Get first worksheet
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            // Convert to JSON
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (jsonData.length < 2) {
                                NotificationSystem.closeLoading();
                                NotificationSystem.error('ไฟล์ Excel ไม่มีข้อมูลหรือรูปแบบไม่ถูกต้อง');
                                return;
                            }
                            
                            let importedCount = 0;
                            let duplicateCount = 0;
                            let errorCount = 0;
                            let duplicateJobNos = [];
                            let errorRows = [];
                            let processedRows = 0;
                            
                            // Create set for faster duplicate checking (case-insensitive) - เฉพาะ Job No. เท่านั้น
                            const existingJobNos = new Set(items.map(item => item.jobNo?.trim().toLowerCase()).filter(Boolean));
                            
                            // Track within this import to prevent duplicates within the same file - เฉพาะ Job No. เท่านั้น
                            const importJobNos = new Set();
                            
                            console.log(`Starting import: ${jsonData.length - 1} rows to process`);
                            console.log(`Existing items in system: ${items.length}`);
                            console.log(`Existing Job Numbers: ${existingJobNos.size}`);
                            
                            // Skip header row (index 0)
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                const rowNumber = i + 1; // Excel row number (1-based)
                                
                                // Skip completely empty rows
                                if (!row || row.length === 0 || !row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
                                    console.log(`Skipping empty row ${rowNumber}`);
                                    continue;
                                }
                                
                                processedRows++;
                                
                                try {
                                    // Get Job No from column C (index 2) - เฉพาะ Job No. เท่านั้นที่ต้องไม่ซ้ำ
                                    const jobNo = row[2] ? String(row[2]).trim() : '';
                                    
                                    if (!jobNo) {
                                        errorCount++;
                                        errorRows.push(`แถว ${rowNumber}: ไม่มี Job No.`);
                                        console.log(`Row ${rowNumber}: Missing Job No.`);
                                        continue;
                                    }
                                    
                                    const jobNoLower = jobNo.toLowerCase();
                                    
                                    // ตรวจสอบ Job No. ซ้ำกับข้อมูลเดิมในระบบ
                                    if (existingJobNos.has(jobNoLower)) {
                                        duplicateCount++;
                                        duplicateJobNos.push(`${jobNo} (แถว ${rowNumber}) - Job No. ซ้ำกับข้อมูลเดิม`);
                                        console.log(`Row ${rowNumber}: Duplicate Job No. with existing data - ${jobNo}`);
                                        continue;
                                    }
                                    
                                    // ตรวจสอบ Job No. ซ้ำภายในไฟล์เดียวกัน
                                    if (importJobNos.has(jobNoLower)) {
                                        duplicateCount++;
                                        duplicateJobNos.push(`${jobNo} (แถว ${rowNumber}) - Job No. ซ้ำในไฟล์เดียวกัน`);
                                        console.log(`Row ${rowNumber}: Duplicate Job No. within import file - ${jobNo}`);
                                        continue;
                                    }
                                    
                                    // Validate required fields
                                    const productName = row[6] ? String(row[6]).trim() : '';
                                    if (!productName) {
                                        errorCount++;
                                        errorRows.push(`แถว ${rowNumber}: ไม่มีชื่อสินค้า`);
                                        console.log(`Row ${rowNumber}: Missing product name`);
                                        continue;
                                    }
                                    
                                    const item = {
                                        id: Date.now() + i + Math.random(),
                                        date: row[0] ? formatExcelDate(row[0]) : '',
                                        mc: row[1] ? String(row[1]).trim() : '',
                                        jobNo: jobNo,
                                        dueDate: row[3] ? formatExcelDate(row[3]) : '',
                                        oe: row[4] ? String(row[4]).trim() : '',
                                        productCode: row[5] ? String(row[5]).trim() : '',
                                        productName: productName,
                                        size: row[7] ? String(row[7]).trim() : '',
                                        color: row[8] ? String(row[8]).trim() : '',
                                        customerCode: row[9] ? String(row[9]).trim() : '',
                                        customerName: row[10] ? String(row[10]).trim() : '',
                                        logo: row[11] ? String(row[11]).trim() : '',
                                        material: row[12] ? String(row[12]).trim() : '',
                                        capCode: row[13] ? String(row[13]).trim() : '',
                                        productionQty: row[14] ? parseInt(row[14]) || 0 : 0,
                                        packPerBag: row[15] ? parseInt(row[15]) || 0 : 0,
                                        bagQty: row[16] ? parseInt(row[16]) || 0 : 0,
                                        waste: row[17] ? parseInt(row[17]) || 0 : 0,
                                        createdBy: currentUser ? currentUser.email : 'system',
                                        createdAt: new Date().toISOString(),
                                        updatedBy: null,
                                        updatedAt: null
                                    };
                                    
                                    items.push(item);
                                    
                                    // เพิ่ม Job No. เข้า tracking sets เพื่อป้องกันการซ้ำในอนาคต
                                    existingJobNos.add(jobNoLower);
                                    importJobNos.add(jobNoLower);
                                    
                                    importedCount++;
                                    console.log(`Row ${rowNumber}: Successfully imported - Job: ${jobNo}`);
                                } catch (error) {
                                    errorCount++;
                                    errorRows.push(`แถว ${rowNumber}: ${error.message}`);
                                    console.error('Error processing row:', rowNumber, error);
                                }
                            }
                            
                            console.log(`Import completed: ${importedCount} imported, ${duplicateCount} duplicates, ${errorCount} errors from ${processedRows} processed rows`);
                            
                            // Save to storage
                            localStorage.setItem('items', JSON.stringify(items));
                            
                            // Save to Firebase if available (async)
                            if (isFirebaseReady && window.db && window.firebaseModules) {
                                const newItems = items.slice(-importedCount);
                                newItems.forEach(async (item) => {
                                    try {
                                        await saveItemToFirebase(item);
                                    } catch (error) {
                                        console.error('Error saving item to Firebase:', error);
                                    }
                                });
                            }
                            
                            finishImport(importedCount, duplicateCount, errorCount, duplicateJobNos, errorRows);
                            
                        } catch (error) {
                            console.error('Excel import error:', error);
                            NotificationSystem.closeLoading();
                            NotificationSystem.error('เกิดข้อผิดพลาดในการอ่านไฟล์ Excel: ' + error.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
            
            // Close menu
            document.getElementById('importMenu').classList.add('hidden');
        }

        function formatExcelDate(excelDate) {
            if (typeof excelDate === 'string') {
                // If already a string, try to parse it
                const date = new Date(excelDate);
                if (!isNaN(date.getTime())) {
                    return date.toISOString().split('T')[0];
                }
                return excelDate;
            } else if (typeof excelDate === 'number') {
                // Excel date serial number
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            return '';
        }

        function finishImport(importedCount, duplicateCount, errorCount, duplicateJobNos = [], errorRows = []) {
            loadItemsTable();
            loadJobSelects();
            updateDashboard();
            
            NotificationSystem.closeLoading();
            
            // Create detailed import report
            let reportHtml = `
                <div class="text-left space-y-3">
                    <div class="grid grid-cols-3 gap-4 text-center mb-4">
                        <div class="bg-green-50 p-3 rounded">
                            <div class="text-2xl font-bold text-green-600">${importedCount}</div>
                            <div class="text-sm text-green-700">นำเข้าสำเร็จ</div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded">
                            <div class="text-2xl font-bold text-yellow-600">${duplicateCount}</div>
                            <div class="text-sm text-yellow-700">ข้อมูลซ้ำ</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded">
                            <div class="text-2xl font-bold text-red-600">${errorCount}</div>
                            <div class="text-sm text-red-700">ข้อผิดพลาด</div>
                        </div>
                    </div>
            `;
            
            if (duplicateCount > 0 && duplicateJobNos.length > 0) {
                reportHtml += `
                    <div class="bg-yellow-50 p-3 rounded">
                        <h4 class="font-semibold text-yellow-800 mb-2">Job No. ที่ซ้ำ (${duplicateCount} รายการ):</h4>
                        <div class="text-sm text-yellow-700 max-h-32 overflow-y-auto">
                            ${duplicateJobNos.slice(0, 10).map(job => `• ${job}`).join('<br>')}
                            ${duplicateJobNos.length > 10 ? `<br>... และอีก ${duplicateJobNos.length - 10} รายการ` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (errorCount > 0 && errorRows.length > 0) {
                reportHtml += `
                    <div class="bg-red-50 p-3 rounded">
                        <h4 class="font-semibold text-red-800 mb-2">ข้อผิดพลาด (${errorCount} รายการ):</h4>
                        <div class="text-sm text-red-700 max-h-32 overflow-y-auto">
                            ${errorRows.slice(0, 10).map(error => `• ${error}`).join('<br>')}
                            ${errorRows.length > 10 ? `<br>... และอีก ${errorRows.length - 10} รายการ` : ''}
                        </div>
                    </div>
                `;
            }
            
            reportHtml += `</div>`;
            
            // Show appropriate notification based on results
            if (importedCount > 0) {
                Swal.fire({
                    title: 'รายงานการนำเข้าข้อมูล',
                    html: reportHtml,
                    icon: 'success',
                    confirmButtonText: 'ตกลง',
                    width: '600px'
                });
                
                // Log import action
                logAuditAction('import', 'items', 'bulk', 'Excel Import', 
                    `นำเข้าข้อมูล ${importedCount} รายการ, ซ้ำ ${duplicateCount} รายการ, ผิดพลาด ${errorCount} รายการ`);
            } else if (duplicateCount > 0 || errorCount > 0) {
                Swal.fire({
                    title: 'ไม่สามารถนำเข้าข้อมูลได้',
                    html: reportHtml,
                    icon: 'warning',
                    confirmButtonText: 'ตกลง',
                    width: '600px'
                });
            } else {
                NotificationSystem.info('ไม่พบข้อมูลที่สามารถนำเข้าได้ในไฟล์ Excel');
            }
        }

        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    NotificationSystem.loading('กำลังอ่านไฟล์ CSV...');
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const csv = e.target.result;
                            const lines = csv.split('\n');
                            const headers = lines[0].split(',');
                            let importedCount = 0;
                            let duplicateCount = 0;
                            
                            // Create set for duplicate checking - เฉพาะ Job No. เท่านั้น
                            const existingJobNos = new Set(items.map(item => item.jobNo?.trim().toLowerCase()).filter(Boolean));
                            const importJobNos = new Set();
                            
                            for (let i = 1; i < lines.length; i++) {
                                if (lines[i].trim()) {
                                    const values = lines[i].split(',');
                                    const jobNo = (values[2] || '').trim();
                                    
                                    if (!jobNo) {
                                        duplicateCount++;
                                        continue;
                                    }
                                    
                                    const jobNoLower = jobNo.toLowerCase();
                                    
                                    // ตรวจสอบ Job No. ซ้ำเท่านั้น
                                    if (existingJobNos.has(jobNoLower) || importJobNos.has(jobNoLower)) {
                                        duplicateCount++;
                                        continue;
                                    }
                                    
                                    const item = {
                                        id: Date.now() + i,
                                        date: values[0] || '',
                                        mc: values[1] || '',
                                        jobNo: jobNo,
                                        dueDate: values[3] || '',
                                        oe: values[4] || '',
                                        productCode: values[5] || '',
                                        productName: values[6] || '',
                                        size: values[7] || '',
                                        color: values[8] || '',
                                        customerCode: values[9] || '',
                                        customerName: values[10] || '',
                                        logo: values[11] || '',
                                        material: values[12] || '',
                                        capCode: values[13] || '',
                                        productionQty: parseInt(values[14]) || 0,
                                        packPerBag: parseInt(values[15]) || 0,
                                        bagQty: parseInt(values[16]) || 0,
                                        waste: parseInt(values[17]) || 0,
                                        createdBy: currentUser ? currentUser.email : 'system',
                                        createdAt: new Date().toISOString(),
                                        updatedBy: null,
                                        updatedAt: null
                                    };
                                    items.push(item);
                                    
                                    // เพิ่ม Job No. เข้า tracking sets เท่านั้น
                                    existingJobNos.add(jobNoLower);
                                    importJobNos.add(jobNoLower);
                                    
                                    importedCount++;
                                }
                            }
                            
                            localStorage.setItem('items', JSON.stringify(items));
                            loadItemsTable();
                            loadJobSelects();
                            updateDashboard();
                            
                            NotificationSystem.closeLoading();
                            
                            let message = `นำเข้าข้อมูล ${importedCount} รายการเรียบร้อย`;
                            if (duplicateCount > 0) {
                                message += `\nข้าม ${duplicateCount} รายการที่ซ้ำ`;
                            }
                            
                            NotificationSystem.success(message);
                        } catch (error) {
                            NotificationSystem.closeLoading();
                            NotificationSystem.error('เกิดข้อผิดพลาดในการอ่านไฟล์ CSV');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
            
            // Close menu
            document.getElementById('importMenu').classList.add('hidden');
        }

        // Audit Trail Functions
        async function logAuditAction(action, itemType, itemId, itemName, details = '', oldData = null, newData = null) {
            try {
                const auditEntry = {
                    id: Date.now() + Math.random(),
                    timestamp: new Date().toISOString(),
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('th-TH'),
                    user: currentUser ? currentUser.email : 'system',
                    userFullName: currentUser ? currentUser.fullName : 'ระบบ',
                    userEmail: currentUser ? currentUser.email : null,
                    userUid: currentUser ? currentUser.uid : null,
                    action: action,
                    itemType: itemType,
                    itemId: itemId,
                    itemName: itemName,
                    details: details,
                    oldData: oldData,
                    newData: newData,
                    ipAddress: await getUserIP(),
                    userAgent: navigator.userAgent,
                    sessionId: getSessionId()
                };

                auditTrail.push(auditEntry);
                localStorage.setItem('auditTrail', JSON.stringify(auditTrail));

                // Save to Firebase if available
                if (isFirebaseReady && window.db && window.firebaseModules) {
                    try {
                        const { addDoc, collection } = window.firebaseModules;
                        await addDoc(collection(window.db, getCollectionPath('auditTrail')), auditEntry);
                    } catch (error) {
                        console.error('Error saving audit trail to Firebase:', error);
                        // Already saved to localStorage, so continue
                    }
                }
            } catch (error) {
                console.error('Error in logAuditAction:', error);
                // Don't throw error to prevent breaking the main functionality
            }
        }

        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'Unknown';
            }
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }

        function loadAuditTrail() {
            try {
                const tbody = document.getElementById('auditTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Sort by timestamp descending
                const sortedAudit = [...auditTrail].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                if (sortedAudit.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-shield-alt text-3xl mb-2"></i>
                            <div>ไม่พบข้อมูล Audit Trail</div>
                        </td>
                    `;
                    tbody.appendChild(row);
                    return;
                }
                
                sortedAudit.forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const actionClass = getActionClass(entry.action);
                    const actionText = getActionText(entry.action);
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${new Date(entry.timestamp).toLocaleString('th-TH')}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold">${entry.userFullName || entry.user || '-'}</div>
                            <div class="text-xs text-gray-600">${entry.user || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${actionClass}">
                                ${actionText}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold">${entry.itemName || '-'}</div>
                            <div class="text-xs text-gray-600">${entry.itemType} ID: ${entry.itemId || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm max-w-xs">
                            <div class="truncate" title="${entry.details || ''}">${entry.details || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${entry.ipAddress || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="viewAuditDetails('${entry.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${currentUser && currentUser.role === 'admin' ? `
                            <button onclick="deleteAuditEntry('${entry.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                updateAuditSummary();
                loadAuditUserFilter();
            } catch (error) {
                console.error('Error loading audit trail:', error);
            }
        }

        function getActionClass(action) {
            const classes = {
                'create': 'bg-green-100 text-green-800',
                'update': 'bg-yellow-100 text-yellow-800',
                'delete': 'bg-red-100 text-red-800',
                'login': 'bg-blue-100 text-blue-800',
                'logout': 'bg-gray-100 text-gray-800',
                'receive': 'bg-indigo-100 text-indigo-800',
                'issue': 'bg-purple-100 text-purple-800'
            };
            return classes[action] || 'bg-gray-100 text-gray-800';
        }

        function getActionText(action) {
            const texts = {
                'create': 'เพิ่มข้อมูล',
                'update': 'แก้ไขข้อมูล',
                'delete': 'ลบข้อมูล',
                'login': 'เข้าสู่ระบบ',
                'logout': 'ออกจากระบบ',
                'receive': 'รับเข้าสินค้า',
                'issue': 'จ่ายออกสินค้า'
            };
            return texts[action] || action;
        }

        function updateAuditSummary() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayActions = auditTrail.filter(entry => entry.date === today);
                const uniqueUsers = [...new Set(auditTrail.map(entry => entry.user).filter(Boolean))];
                const dataChanges = auditTrail.filter(entry => ['create', 'update', 'delete'].includes(entry.action));
                
                const totalElement = document.getElementById('totalAuditActions');
                const todayElement = document.getElementById('todayAuditActions');
                const usersElement = document.getElementById('activeUsers');
                const changesElement = document.getElementById('dataChanges');
                
                if (totalElement) totalElement.textContent = auditTrail.length.toLocaleString();
                if (todayElement) todayElement.textContent = todayActions.length.toLocaleString();
                if (usersElement) usersElement.textContent = uniqueUsers.length.toLocaleString();
                if (changesElement) changesElement.textContent = dataChanges.length.toLocaleString();
            } catch (error) {
                console.error('Error updating audit summary:', error);
            }
        }

        function loadAuditUserFilter() {
            try {
                const select = document.getElementById('auditUserFilter');
                if (!select) return;
                
                const currentOptions = Array.from(select.options).map(opt => opt.value);
                const uniqueUsers = [...new Set(auditTrail.map(entry => entry.user).filter(Boolean))];
                
                uniqueUsers.forEach(username => {
                    if (!currentOptions.includes(username)) {
                        const user = users.find(u => u.username === username);
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = user ? `${user.fullName} (${username})` : username;
                        select.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error loading audit user filter:', error);
            }
        }

        function searchAuditTrail() {
            const searchTerm = document.getElementById('searchAudit').value.toLowerCase();
            const actionType = document.getElementById('auditActionType').value;
            const userFilter = document.getElementById('auditUserFilter').value;
            const dateFrom = document.getElementById('auditDateFrom').value;
            const dateTo = document.getElementById('auditDateTo').value;
            
            let filteredAudit = [...auditTrail];
            
            // Filter by search term
            if (searchTerm) {
                filteredAudit = filteredAudit.filter(entry => 
                    (entry.user && entry.user.toLowerCase().includes(searchTerm)) ||
                    (entry.userFullName && entry.userFullName.toLowerCase().includes(searchTerm)) ||
                    (entry.itemName && entry.itemName.toLowerCase().includes(searchTerm)) ||
                    (entry.details && entry.details.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filter by action type
            if (actionType !== 'all') {
                filteredAudit = filteredAudit.filter(entry => entry.action === actionType);
            }
            
            // Filter by user
            if (userFilter !== 'all') {
                filteredAudit = filteredAudit.filter(entry => entry.user === userFilter);
            }
            
            // Filter by date range
            if (dateFrom) {
                filteredAudit = filteredAudit.filter(entry => entry.date >= dateFrom);
            }
            if (dateTo) {
                filteredAudit = filteredAudit.filter(entry => entry.date <= dateTo);
            }
            
            // Update table
            displayFilteredAudit(filteredAudit);
        }

        function displayFilteredAudit(filteredAudit) {
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = '';
            
            filteredAudit.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const actionClass = getActionClass(entry.action);
                const actionText = getActionText(entry.action);
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${new Date(entry.timestamp).toLocaleString('th-TH')}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="font-semibold">${entry.userFullName}</div>
                        <div class="text-xs text-gray-600">${entry.user}</div>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 rounded text-xs ${actionClass}">
                            ${actionText}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="font-semibold">${entry.itemName || '-'}</div>
                        <div class="text-xs text-gray-600">${entry.itemType} ID: ${entry.itemId || '-'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm max-w-xs">
                        <div class="truncate" title="${entry.details}">${entry.details || '-'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${entry.ipAddress || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewAuditDetails('${entry.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${currentUser && currentUser.role === 'admin' ? `
                        <button onclick="deleteAuditEntry('${entry.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function refreshAuditTrail() {
            loadAuditTrail();
            NotificationSystem.success('รีเฟรช Audit Trail เรียบร้อย');
        }

        function autocompleteAuditSearch() {
            const searchTerm = document.getElementById('searchAudit').value.toLowerCase();
            
            if (searchTerm.length < 2) {
                document.getElementById('searchAuditResults').classList.add('hidden');
                return;
            }
            
            const results = auditTrail.filter(entry => 
                (entry.user && entry.user.toLowerCase().includes(searchTerm)) ||
                (entry.userFullName && entry.userFullName.toLowerCase().includes(searchTerm)) ||
                (entry.itemName && entry.itemName.toLowerCase().includes(searchTerm)) ||
                (entry.details && entry.details.toLowerCase().includes(searchTerm))
            ).slice(0, 8);
            
            showAutocompleteResults('searchAuditResults', results, (entry) => {
                document.getElementById('searchAudit').value = entry.itemName || entry.user;
                document.getElementById('searchAuditResults').classList.add('hidden');
                searchAuditTrail();
            });
        }

        async function viewAuditDetails(entryId) {
            const entry = auditTrail.find(e => e.id == entryId);
            if (!entry) return;
            
            let detailsHtml = `
                <div class="space-y-3">
                    <div><strong>วันที่/เวลา:</strong> ${new Date(entry.timestamp).toLocaleString('th-TH')}</div>
                    <div><strong>ผู้ใช้:</strong> ${entry.userFullName} (${entry.user})</div>
                    <div><strong>การดำเนินการ:</strong> ${getActionText(entry.action)}</div>
                    <div><strong>รายการ:</strong> ${entry.itemName || '-'}</div>
                    <div><strong>ประเภท:</strong> ${entry.itemType}</div>
                    <div><strong>รายละเอียด:</strong> ${entry.details || '-'}</div>
                    <div><strong>IP Address:</strong> ${entry.ipAddress || '-'}</div>
                    <div><strong>Session ID:</strong> ${entry.sessionId || '-'}</div>
            `;
            
            if (entry.oldData || entry.newData) {
                detailsHtml += `<hr class="my-4">`;
                if (entry.oldData) {
                    detailsHtml += `
                        <div><strong>ข้อมูลเดิม:</strong></div>
                        <pre class="bg-gray-100 p-2 rounded text-xs overflow-auto max-h-32">${JSON.stringify(entry.oldData, null, 2)}</pre>
                    `;
                }
                if (entry.newData) {
                    detailsHtml += `
                        <div><strong>ข้อมูลใหม่:</strong></div>
                        <pre class="bg-gray-100 p-2 rounded text-xs overflow-auto max-h-32">${JSON.stringify(entry.newData, null, 2)}</pre>
                    `;
                }
            }
            
            detailsHtml += `</div>`;
            
            Swal.fire({
                title: 'รายละเอียด Audit Trail',
                html: detailsHtml,
                width: '600px',
                confirmButtonText: 'ปิด'
            });
        }

        async function deleteAuditEntry(entryId) {
            if (currentUser.role !== 'admin') {
                NotificationSystem.error('เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถลบ Audit Trail ได้');
                return;
            }
            
            const confirmed = await NotificationSystem.confirmDelete('รายการ Audit Trail นี้');
            
            if (confirmed) {
                auditTrail = auditTrail.filter(entry => entry.id != entryId);
                
                if (isFirebaseReady) {
                    try {
                        await deleteDoc(doc(window.db, 'auditTrail', entryId));
                    } catch (error) {
                        console.error('Error deleting audit entry from Firebase:', error);
                    }
                }
                
                localStorage.setItem('auditTrail', JSON.stringify(auditTrail));
                loadAuditTrail();
                
                // Log the deletion of audit trail (meta-audit)
                await logAuditAction('delete', 'auditTrail', entryId, 'Audit Trail Entry', 'ลบรายการ Audit Trail');
                
                NotificationSystem.success('ลบรายการ Audit Trail เรียบร้อย');
            }
        }

        function toggleAuditExportMenu() {
            const menu = document.getElementById('auditExportMenu');
            menu.classList.toggle('hidden');
        }

        function exportAuditExcel() {
            if (auditTrail.length === 0) {
                NotificationSystem.warning('ไม่มีข้อมูล Audit Trail ให้ Export');
                return;
            }

            NotificationSystem.loading('กำลังสร้างไฟล์ Excel Audit Trail...');

            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    
                    const headers = ['วันที่/เวลา', 'ผู้ใช้', 'ชื่อเต็ม', 'การดำเนินการ', 'ประเภทรายการ', 'รายการ', 'รายละเอียด', 'IP Address', 'Session ID'];
                    
                    const data = auditTrail.map(entry => [
                        new Date(entry.timestamp).toLocaleString('th-TH'),
                        entry.user || '',
                        entry.userFullName || '',
                        getActionText(entry.action),
                        entry.itemType || '',
                        entry.itemName || '',
                        entry.details || '',
                        entry.ipAddress || '',
                        entry.sessionId || ''
                    ]);
                    
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    
                    ws['!cols'] = [
                        {wch: 20}, {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15},
                        {wch: 25}, {wch: 30}, {wch: 15}, {wch: 20}
                    ];
                    
                    const headerStyle = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "DC2626" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                    
                    for (let i = 0; i < headers.length; i++) {
                        const cellRef = XLSX.utils.encode_cell({ r: 0, c: i });
                        if (!ws[cellRef]) ws[cellRef] = {};
                        ws[cellRef].s = headerStyle;
                    }
                    
                    XLSX.utils.book_append_sheet(wb, ws, "Audit Trail");
                    
                    const filename = `audit_trail_${new Date().toISOString().split('T')[0]}.xlsx`;
                    XLSX.writeFile(wb, filename);
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.success(`Export Audit Trail ${auditTrail.length} รายการเป็น Excel เรียบร้อย`);
                    
                    document.getElementById('auditExportMenu').classList.add('hidden');
                    
                    // Log export action
                    logAuditAction('export', 'auditTrail', 'all', 'Audit Trail Export', `Export ${auditTrail.length} รายการเป็น Excel`);
                } catch (error) {
                    NotificationSystem.closeLoading();
                    NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel');
                }
            }, 1000);
        }

        function exportAuditCSV() {
            if (auditTrail.length === 0) {
                NotificationSystem.warning('ไม่มีข้อมูล Audit Trail ให้ Export');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," + 
                "วันที่/เวลา,ผู้ใช้,ชื่อเต็ม,การดำเนินการ,ประเภทรายการ,รายการ,รายละเอียด,IP Address\n" +
                auditTrail.map(entry => 
                    `"${new Date(entry.timestamp).toLocaleString('th-TH')}","${entry.user}","${entry.userFullName}","${getActionText(entry.action)}","${entry.itemType}","${entry.itemName}","${entry.details}","${entry.ipAddress}"`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `audit_trail_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.getElementById('auditExportMenu').classList.add('hidden');
            NotificationSystem.success(`Export Audit Trail ${auditTrail.length} รายการเป็น CSV เรียบร้อย`);
            
            // Log export action
            logAuditAction('export', 'auditTrail', 'all', 'Audit Trail Export', `Export ${auditTrail.length} รายการเป็น CSV`);
        }

        // Missing function implementations
        function searchAuditTrail() {
            try {
                const searchTerm = document.getElementById('searchAudit')?.value.toLowerCase() || '';
                const actionType = document.getElementById('auditActionType')?.value || 'all';
                const userFilter = document.getElementById('auditUserFilter')?.value || 'all';
                const dateFrom = document.getElementById('auditDateFrom')?.value || '';
                const dateTo = document.getElementById('auditDateTo')?.value || '';
                
                let filteredAudit = [...auditTrail];
                
                // Filter by search term
                if (searchTerm) {
                    filteredAudit = filteredAudit.filter(entry => 
                        (entry.user && entry.user.toLowerCase().includes(searchTerm)) ||
                        (entry.userFullName && entry.userFullName.toLowerCase().includes(searchTerm)) ||
                        (entry.itemName && entry.itemName.toLowerCase().includes(searchTerm)) ||
                        (entry.details && entry.details.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Filter by action type
                if (actionType !== 'all') {
                    filteredAudit = filteredAudit.filter(entry => entry.action === actionType);
                }
                
                // Filter by user
                if (userFilter !== 'all') {
                    filteredAudit = filteredAudit.filter(entry => entry.user === userFilter);
                }
                
                // Filter by date range
                if (dateFrom) {
                    filteredAudit = filteredAudit.filter(entry => entry.date >= dateFrom);
                }
                if (dateTo) {
                    filteredAudit = filteredAudit.filter(entry => entry.date <= dateTo);
                }
                
                // Update table
                displayFilteredAudit(filteredAudit);
            } catch (error) {
                console.error('Error searching audit trail:', error);
            }
        }

        function displayFilteredAudit(filteredAudit) {
            try {
                const tbody = document.getElementById('auditTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                filteredAudit.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(entry => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const actionClass = getActionClass(entry.action);
                    const actionText = getActionText(entry.action);
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${new Date(entry.timestamp).toLocaleString('th-TH')}</td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold">${entry.userFullName || entry.user || '-'}</div>
                            <div class="text-xs text-gray-600">${entry.user || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 rounded text-xs ${actionClass}">
                                ${actionText}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="font-semibold">${entry.itemName || '-'}</div>
                            <div class="text-xs text-gray-600">${entry.itemType} ID: ${entry.itemId || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm max-w-xs">
                            <div class="truncate" title="${entry.details || ''}">${entry.details || '-'}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${entry.ipAddress || '-'}</td>
                        <td class="px-4 py-3 text-sm">
                            <button onclick="viewAuditDetails('${entry.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${currentUser && currentUser.role === 'admin' ? `
                            <button onclick="deleteAuditEntry('${entry.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error displaying filtered audit:', error);
            }
        }

        function refreshAuditTrail() {
            try {
                loadAuditTrail();
                NotificationSystem.success('รีเฟรช Audit Trail เรียบร้อย');
            } catch (error) {
                console.error('Error refreshing audit trail:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการรีเฟรช Audit Trail');
            }
        }

        function autocompleteAuditSearch() {
            // Implementation for audit search autocomplete
            const searchTerm = document.getElementById('searchAudit')?.value.toLowerCase() || '';
            
            if (searchTerm.length < 2) {
                const resultsElement = document.getElementById('searchAuditResults');
                if (resultsElement) resultsElement.classList.add('hidden');
                return;
            }
            
            // Filter and show results
            const results = auditTrail.filter(entry => 
                (entry.user && entry.user.toLowerCase().includes(searchTerm)) ||
                (entry.userFullName && entry.userFullName.toLowerCase().includes(searchTerm)) ||
                (entry.itemName && entry.itemName.toLowerCase().includes(searchTerm))
            ).slice(0, 5);
            
            // Show autocomplete results if element exists
            const resultsElement = document.getElementById('searchAuditResults');
            if (resultsElement && results.length > 0) {
                resultsElement.innerHTML = results.map(entry => `
                    <div class="autocomplete-item" onclick="selectAuditSearchResult('${entry.itemName || entry.user}')">
                        <div class="font-semibold text-sm">${entry.itemName || entry.user}</div>
                        <div class="text-xs text-gray-600">${entry.details || ''}</div>
                    </div>
                `).join('');
                resultsElement.classList.remove('hidden');
            }
        }

        function selectAuditSearchResult(value) {
            const searchInput = document.getElementById('searchAudit');
            if (searchInput) {
                searchInput.value = value;
                searchAuditTrail();
            }
            const resultsElement = document.getElementById('searchAuditResults');
            if (resultsElement) resultsElement.classList.add('hidden');
        }

        // Additional Audit Trail Functions
        async function viewAuditDetails(entryId) {
            try {
                const entry = auditTrail.find(e => e.id == entryId);
                if (!entry) {
                    NotificationSystem.error('ไม่พบข้อมูล Audit Trail');
                    return;
                }
                
                let detailsHtml = `
                    <div class="space-y-4 text-left">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><strong>วันที่/เวลา:</strong><br>${new Date(entry.timestamp).toLocaleString('th-TH')}</div>
                            <div><strong>ผู้ใช้:</strong><br>${entry.userFullName || entry.user || '-'} (${entry.user || '-'})</div>
                            <div><strong>การดำเนินการ:</strong><br><span class="px-2 py-1 rounded text-xs ${getActionClass(entry.action)}">${getActionText(entry.action)}</span></div>
                            <div><strong>ประเภทรายการ:</strong><br>${entry.itemType || '-'}</div>
                            <div class="md:col-span-2"><strong>รายการ:</strong><br>${entry.itemName || '-'}</div>
                            <div class="md:col-span-2"><strong>รายละเอียด:</strong><br>${entry.details || '-'}</div>
                            <div><strong>IP Address:</strong><br>${entry.ipAddress || '-'}</div>
                            <div><strong>Session ID:</strong><br>${entry.sessionId || '-'}</div>
                        </div>
                `;
                
                if (entry.oldData || entry.newData) {
                    detailsHtml += `
                        <hr class="my-4">
                        <div class="space-y-3">
                    `;
                    
                    if (entry.oldData) {
                        detailsHtml += `
                            <div>
                                <strong class="text-red-600">ข้อมูลเดิม (ก่อนการเปลี่ยนแปลง):</strong>
                                <pre class="bg-red-50 border border-red-200 p-3 rounded text-xs overflow-auto max-h-40 mt-2">${JSON.stringify(entry.oldData, null, 2)}</pre>
                            </div>
                        `;
                    }
                    
                    if (entry.newData) {
                        detailsHtml += `
                            <div>
                                <strong class="text-green-600">ข้อมูลใหม่ (หลังการเปลี่ยนแปลง):</strong>
                                <pre class="bg-green-50 border border-green-200 p-3 rounded text-xs overflow-auto max-h-40 mt-2">${JSON.stringify(entry.newData, null, 2)}</pre>
                            </div>
                        `;
                    }
                    
                    detailsHtml += `</div>`;
                }
                
                if (entry.userAgent) {
                    detailsHtml += `
                        <hr class="my-4">
                        <div>
                            <strong>User Agent:</strong><br>
                            <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded mt-1">${entry.userAgent}</div>
                        </div>
                    `;
                }
                
                detailsHtml += `</div>`;
                
                Swal.fire({
                    title: `<i class="fas fa-shield-alt text-red-600 mr-2"></i>รายละเอียด Audit Trail`,
                    html: detailsHtml,
                    width: '800px',
                    confirmButtonText: 'ปิด',
                    showCancelButton: false,
                    customClass: {
                        popup: 'text-left'
                    }
                });
            } catch (error) {
                console.error('Error viewing audit details:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการแสดงรายละเอียด');
            }
        }

        async function deleteAuditEntry(entryId) {
            try {
                if (!currentUser || currentUser.role !== 'admin') {
                    NotificationSystem.error('เฉพาะผู้ดูแลระบบเท่านั้นที่สามารถลบ Audit Trail ได้');
                    return;
                }
                
                const entry = auditTrail.find(e => e.id == entryId);
                if (!entry) {
                    NotificationSystem.error('ไม่พบรายการ Audit Trail');
                    return;
                }
                
                const confirmed = await NotificationSystem.confirmDelete(`รายการ Audit Trail: ${entry.itemName || entry.details || 'รายการนี้'}`);
                
                if (confirmed) {
                    NotificationSystem.loading('กำลังลบรายการ Audit Trail...');
                    
                    // Remove from local array
                    auditTrail = auditTrail.filter(e => e.id != entryId);
                    
                    // Save to localStorage
                    localStorage.setItem('auditTrail', JSON.stringify(auditTrail));
                    
                    // Remove from Firebase if available
                    if (isFirebaseReady && window.db && window.firebaseModules) {
                        try {
                            const { deleteDoc, doc } = window.firebaseModules;
                            await deleteDoc(doc(window.db, 'auditTrail', entryId));
                        } catch (error) {
                            console.error('Error deleting audit entry from Firebase:', error);
                            // Continue anyway since we removed from local storage
                        }
                    }
                    
                    // Reload the audit trail table
                    loadAuditTrail();
                    
                    NotificationSystem.closeLoading();
                    NotificationSystem.success('ลบรายการ Audit Trail เรียบร้อย');
                    
                    // Log the deletion of audit trail (meta-audit)
                    await logAuditAction('delete', 'auditTrail', entryId, 'Audit Trail Entry', 
                        `ลบรายการ Audit Trail: ${entry.itemName || entry.details}`, entry, null);
                }
            } catch (error) {
                NotificationSystem.closeLoading();
                console.error('Error deleting audit entry:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการลบรายการ Audit Trail');
            }
        }

        function toggleAuditExportMenu() {
            try {
                const menu = document.getElementById('auditExportMenu');
                if (menu) {
                    menu.classList.toggle('hidden');
                    
                    // Close other menus
                    document.getElementById('importMenu')?.classList.add('hidden');
                    document.getElementById('exportMenu')?.classList.add('hidden');
                    document.getElementById('inventoryExportMenu')?.classList.add('hidden');
                    document.getElementById('historyExportMenu')?.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error toggling audit export menu:', error);
            }
        }

        function exportAuditExcel() {
            try {
                if (auditTrail.length === 0) {
                    NotificationSystem.warning('ไม่มีข้อมูล Audit Trail ให้ Export');
                    return;
                }

                NotificationSystem.loading('กำลังสร้างไฟล์ Excel Audit Trail...');

                setTimeout(() => {
                    try {
                        const wb = XLSX.utils.book_new();
                        
                        // Prepare headers
                        const headers = [
                            'วันที่/เวลา', 'ผู้ใช้', 'ชื่อเต็ม', 'การดำเนินการ', 'ประเภทรายการ', 
                            'รายการ', 'รายละเอียด', 'IP Address', 'Session ID', 'User Agent'
                        ];
                        
                        // Prepare data
                        const data = auditTrail
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .map(entry => [
                                new Date(entry.timestamp).toLocaleString('th-TH'),
                                entry.user || '',
                                entry.userFullName || '',
                                getActionText(entry.action),
                                entry.itemType || '',
                                entry.itemName || '',
                                entry.details || '',
                                entry.ipAddress || '',
                                entry.sessionId || '',
                                entry.userAgent || ''
                            ]);
                        
                        // Create worksheet
                        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                        
                        // Set column widths
                        ws['!cols'] = [
                            {wch: 20}, // วันที่/เวลา
                            {wch: 15}, // ผู้ใช้
                            {wch: 20}, // ชื่อเต็ม
                            {wch: 15}, // การดำเนินการ
                            {wch: 15}, // ประเภทรายการ
                            {wch: 25}, // รายการ
                            {wch: 40}, // รายละเอียด
                            {wch: 15}, // IP Address
                            {wch: 20}, // Session ID
                            {wch: 30}  // User Agent
                        ];
                        
                        // Style header row
                        const headerStyle = {
                            font: { bold: true, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "DC2626" } }, // Red color for audit trail
                            alignment: { horizontal: "center", vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            }
                        };
                        
                        // Apply header styling
                        for (let i = 0; i < headers.length; i++) {
                            const cellRef = XLSX.utils.encode_cell({ r: 0, c: i });
                            if (!ws[cellRef]) ws[cellRef] = {};
                            ws[cellRef].s = headerStyle;
                        }
                        
                        // Add data styling
                        for (let r = 1; r <= data.length; r++) {
                            for (let c = 0; c < headers.length; c++) {
                                const cellRef = XLSX.utils.encode_cell({ r, c });
                                if (!ws[cellRef]) ws[cellRef] = {};
                                ws[cellRef].s = {
                                    border: {
                                        top: { style: "thin", color: { rgb: "CCCCCC" } },
                                        bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                                        left: { style: "thin", color: { rgb: "CCCCCC" } },
                                        right: { style: "thin", color: { rgb: "CCCCCC" } }
                                    },
                                    alignment: { vertical: "top", wrapText: true }
                                };
                            }
                        }
                        
                        // Add worksheet to workbook
                        XLSX.utils.book_append_sheet(wb, ws, "Audit Trail");
                        
                        // Generate filename with timestamp
                        const now = new Date();
                        const filename = `audit_trail_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}.xlsx`;
                        
                        // Save file
                        XLSX.writeFile(wb, filename);
                        
                        NotificationSystem.closeLoading();
                        NotificationSystem.success(`Export Audit Trail ${auditTrail.length.toLocaleString()} รายการเป็น Excel เรียบร้อย`);
                        
                        // Close menu
                        document.getElementById('auditExportMenu')?.classList.add('hidden');
                        
                        // Log export action
                        logAuditAction('export', 'auditTrail', 'bulk', 'Audit Trail Export', 
                            `Export Audit Trail ${auditTrail.length} รายการเป็น Excel (${filename})`);
                            
                    } catch (error) {
                        NotificationSystem.closeLoading();
                        console.error('Error creating Excel file:', error);
                        NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ Excel: ' + error.message);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error in exportAuditExcel:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการ Export Excel');
            }
        }

        function exportAuditCSV() {
            try {
                if (auditTrail.length === 0) {
                    NotificationSystem.warning('ไม่มีข้อมูล Audit Trail ให้ Export');
                    return;
                }

                NotificationSystem.loading('กำลังสร้างไฟล์ CSV Audit Trail...');

                setTimeout(() => {
                    try {
                        // Prepare CSV content with proper escaping
                        const headers = [
                            'วันที่/เวลา', 'ผู้ใช้', 'ชื่อเต็ม', 'การดำเนินการ', 'ประเภทรายการ', 
                            'รายการ', 'รายละเอียด', 'IP Address', 'Session ID'
                        ];
                        
                        const csvRows = [headers.join(',')];
                        
                        // Add data rows
                        auditTrail
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .forEach(entry => {
                                const row = [
                                    `"${new Date(entry.timestamp).toLocaleString('th-TH')}"`,
                                    `"${(entry.user || '').replace(/"/g, '""')}"`,
                                    `"${(entry.userFullName || '').replace(/"/g, '""')}"`,
                                    `"${getActionText(entry.action)}"`,
                                    `"${(entry.itemType || '').replace(/"/g, '""')}"`,
                                    `"${(entry.itemName || '').replace(/"/g, '""')}"`,
                                    `"${(entry.details || '').replace(/"/g, '""')}"`,
                                    `"${(entry.ipAddress || '').replace(/"/g, '""')}"`,
                                    `"${(entry.sessionId || '').replace(/"/g, '""')}"`
                                ];
                                csvRows.push(row.join(','));
                            });
                        
                        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + csvRows.join('\n');
                        
                        // Create download link
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        
                        // Generate filename with timestamp
                        const now = new Date();
                        const filename = `audit_trail_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}-${String(now.getMinutes()).padStart(2, '0')}.csv`;
                        link.setAttribute("download", filename);
                        
                        // Trigger download
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        NotificationSystem.closeLoading();
                        NotificationSystem.success(`Export Audit Trail ${auditTrail.length.toLocaleString()} รายการเป็น CSV เรียบร้อย`);
                        
                        // Close menu
                        document.getElementById('auditExportMenu')?.classList.add('hidden');
                        
                        // Log export action
                        logAuditAction('export', 'auditTrail', 'bulk', 'Audit Trail Export', 
                            `Export Audit Trail ${auditTrail.length} รายการเป็น CSV (${filename})`);
                            
                    } catch (error) {
                        NotificationSystem.closeLoading();
                        console.error('Error creating CSV file:', error);
                        NotificationSystem.error('เกิดข้อผิดพลาดในการสร้างไฟล์ CSV: ' + error.message);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error in exportAuditCSV:', error);
                NotificationSystem.error('เกิดข้อผิดพลาดในการ Export CSV');
            }
        }

        // Make functions globally available
        window.viewAuditDetails = viewAuditDetails;
        window.deleteAuditEntry = deleteAuditEntry;
        window.toggleAuditExportMenu = toggleAuditExportMenu;
        window.exportAuditExcel = exportAuditExcel;
        window.exportAuditCSV = exportAuditCSV;
        window.searchAuditTrail = searchAuditTrail;
        window.refreshAuditTrail = refreshAuditTrail;
        window.autocompleteAuditSearch = autocompleteAuditSearch;
        window.editItem = editItem;
        window.viewItemDetail = viewItemDetail;
        window.deleteItem = deleteItem;
        window.logout = logout;
        window.showSection = showSection;
        window.switchTab = switchTab;
        window.nextTab = nextTab;
        window.previousTab = previousTab;
        window.calculateBagQty = calculateBagQty;
        window.updateCalculatedTotal = updateCalculatedTotal;
        window.showAddItemForm = showAddItemForm;
        window.hideAddItemForm = hideAddItemForm;
        window.showAddUserForm = showAddUserForm;
        window.hideAddUserForm = hideAddUserForm;
        window.saveUser = saveUser;
        window.toggleUserStatus = toggleUserStatus;
        window.deleteUser = deleteUser;
        window.toggleImportMenu = toggleImportMenu;
        window.toggleExportMenu = toggleExportMenu;
        window.toggleInventoryExportMenu = toggleInventoryExportMenu;
        window.toggleHistoryExportMenu = toggleHistoryExportMenu;
        window.importExcel = importExcel;
        window.importCSV = importCSV;
        window.exportExcel = exportExcel;
        window.exportCSV = exportCSV;
        window.exportInventoryExcel = exportInventoryExcel;
        window.exportInventoryCSV = exportInventoryCSV;
        window.exportHistoryExcel = exportHistoryExcel;
        window.exportHistoryCSV = exportHistoryCSV;
        window.changeItemsPerPage = changeItemsPerPage;
        window.searchItemTable = searchItemTable;
        window.clearItemTableSearch = clearItemTableSearch;
        window.sortItemTable = sortItemTable;
        window.goToItemsPage = goToItemsPage;
        window.previousItemsPage = previousItemsPage;
        window.nextItemsPage = nextItemsPage;
        window.loadJobDetails = loadJobDetails;
        window.useDataBagQty = useDataBagQty;
        window.customBagQty = customBagQty;
        window.selectStickerLayout = selectStickerLayout;
        window.previewSticker = previewSticker;
        window.generateStickers = generateStickers;
        window.printStickers = printStickers;
        window.previewPrint = previewPrint;
        window.exitPreview = exitPreview;
        window.selectAllPages = selectAllPages;
        window.deselectAllPages = deselectAllPages;
        window.selectPageRange = selectPageRange;
        window.printSelectedPages = printSelectedPages;
        window.updateSelectedStickersCount = updateSelectedStickersCount;
        window.selectAllStickers = selectAllStickers;
        window.deselectAllStickers = deselectAllStickers;
        window.toggleStickerSelection = toggleStickerSelection;
        window.printQRStickers = printQRStickers;
        window.changePreviewLayout = changePreviewLayout;
        window.closeStickerPreview = closeStickerPreview;
        window.confirmAndGenerate = confirmAndGenerate;
        window.handleReceiveJobNoInput = handleReceiveJobNoInput;
        window.handleReceiveJobNoKeydown = handleReceiveJobNoKeydown;
        window.loadReceiveData = loadReceiveData;
        window.calculateReceiveTotal = calculateReceiveTotal;
        window.saveReceive = saveReceive;
        window.handleIssueJobNoInput = handleIssueJobNoInput;
        window.handleIssueJobNoKeydown = handleIssueJobNoKeydown;
        window.loadIssueData = loadIssueData;
        window.calculateIssueTotal = calculateIssueTotal;
        window.saveIssue = saveIssue;
        window.searchInventory = searchInventory;
        window.refreshInventory = refreshInventory;
        window.viewItemDetails = viewItemDetails;
        window.searchHistory = searchHistory;
        window.deleteHistory = deleteHistory;
        window.startBarcodeScanner = startBarcodeScanner;
        window.stopBarcodeScanner = stopBarcodeScanner;
        window.quickSearch = quickSearch;
        window.showQuickSearchResults = showQuickSearchResults;
        window.hideQuickSearchResults = hideQuickSearchResults;
        window.autocompleteJobNo = autocompleteJobNo;
        window.autocompleteInventorySearch = autocompleteInventorySearch;
        window.autocompleteHistorySearch = autocompleteHistorySearch;

        // Hide autocomplete and menus when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.autocomplete-container')) {
                document.querySelectorAll('.autocomplete-list').forEach(list => {
                    list.classList.add('hidden');
                });
            }
            
            // Close dropdown menus when clicking outside
            if (!event.target.closest('.relative')) {
                document.getElementById('importMenu')?.classList.add('hidden');
                document.getElementById('exportMenu')?.classList.add('hidden');
                document.getElementById('inventoryExportMenu')?.classList.add('hidden');
                document.getElementById('historyExportMenu')?.classList.add('hidden');
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97110c5d918f7b50',t:'MTc1NTUxNjMwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
